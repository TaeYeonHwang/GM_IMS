<script>
  let allItems = [];
  let stream = null;
  let qrStream = null;
  let orderQRStream = null;
  let orderItems = [];
  let currentOrderType = 'b2c';
  let isNavigating = false; // Browser history navigation support

  // Handle browser back button
  window.addEventListener('popstate', function(event) {
    if (event.state && event.state.screen) {
      isNavigating = true;
      const screenName = event.state.screen;
      
      // Hide all screens
      hideAllScreens();
      
      // Show the appropriate screen
      const screen = document.getElementById(screenName);
      if (screen) {
        screen.style.display = 'block';
        screen.classList.add('active');
      }
      
      // Stop cameras
      stopCamera();
      stopQRCamera();
      stopOrderQRCamera();
      
      // Special handling for certain screens
      if (screenName === 'listScreen') {
        loadAllItems();
      } else if (screenName === 'guideScreen') {
        loadGuideImage();
      } else if (screenName === 'orderMainScreen') {
        // Reload order main screen data
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth() + 1;
        const day = today.getDate();
        const orderDate = year.toString() + month.toString().padStart(2, '0') + day.toString().padStart(2, '0');
        
        document.getElementById('todayDateText').textContent = `${year}ë…„ ${month}ì›” ${day}ì¼`;
        document.getElementById('searchOrderYear').value = year;
        document.getElementById('searchOrderMonth').value = month;
        document.getElementById('searchOrderDay').value = day;
        
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              document.getElementById('todayOrderCount').textContent = result.existingOrders || 0;
              if (result.orderIndex > 1) {
                document.getElementById('searchOrderIndex').value = result.orderIndex - 1;
              } else {
                document.getElementById('searchOrderIndex').value = '';
              }
            }
          })
          .getNewOrderIndex(orderDate);
      } else if (screenName === 'orderFormScreen') {
        // Keep current order form state
      } else if (screenName === 'qrSearchScreen') {
        const inputElement = document.getElementById('qrInput');
        setTimeout(() => {
          inputElement.focus();
        }, 100);
      }
      
      isNavigating = false;
    }
  });

  // Helper function to navigate with history
  function navigateToScreen(screenId) {
    if (!isNavigating) {
      history.pushState({ screen: screenId }, '', '#' + screenId);
    }
  }

  function debugLog(m, t) {
    const b = document.getElementById('debugBox');
    const l = document.getElementById('debugLogs');
    b.style.display = 'block';
    const c = t === 'error' ? 'debug-error' : (t === 'success' ? 'debug-success' : '');
    const e = document.createElement('div');
    e.className = 'debug-log ' + c;
    e.textContent = `[${new Date().toLocaleTimeString()}] ${m}`;
    l.appendChild(e);
    l.scrollTop = l.scrollHeight;
    console.log(m);
  }

  function clearDebugLog() {
    document.getElementById('debugLogs').innerHTML = '';
    document.getElementById('debugBox').style.display = 'none';
  }

  function qrDebugLog(m, t) {
    const b = document.getElementById('qrDebugBox');
    const l = document.getElementById('qrDebugLogs');
    b.style.display = 'block';
    const c = t === 'error' ? 'debug-error' : (t === 'success' ? 'debug-success' : '');
    const e = document.createElement('div');
    e.className = 'debug-log ' + c;
    e.textContent = `[${new Date().toLocaleTimeString()}] ${m}`;
    l.appendChild(e);
    l.scrollTop = l.scrollHeight;
    console.log(m);
  }

  function clearQRDebugLog() {
    document.getElementById('qrDebugLogs').innerHTML = '';
    document.getElementById('qrDebugBox').style.display = 'none';
  }

  function orderDebugLog(m, t) {
    const b = document.getElementById('orderDebugBox');
    const l = document.getElementById('orderDebugLogs');
    b.style.display = 'block';
    const c = t === 'error' ? 'debug-error' : (t === 'success' ? 'debug-success' : '');
    const e = document.createElement('div');
    e.className = 'debug-log ' + c;
    e.textContent = '[' + new Date().toLocaleTimeString() + '] ' + m;
    l.appendChild(e);
    l.scrollTop = l.scrollHeight;
    console.log(m);
  }

  function clearOrderDebugLog() {
    document.getElementById('orderDebugLogs').innerHTML = '';
    document.getElementById('orderDebugBox').style.display = 'none';
  }

  function hideAllScreens() {
    ['mainScreen', 'inventoryMenuScreen', 'searchMenuScreen', 'searchScreen', 'qrSearchScreen', 'listScreen', 'guideScreen', 'revisionHistoryScreen', 'orderMainScreen', 'orderFormScreen', 'orderViewScreen'].forEach(id => {
      document.getElementById(id).style.display = 'none';
      document.getElementById(id).classList.remove('active');
    });
  }

  function showMain() {
    hideAllScreens();
    const s = document.getElementById('mainScreen');
    s.style.display = 'block';
    s.classList.add('active');
    stopCamera();
    stopQRCamera();
    stopOrderQRCamera();
    navigateToScreen('mainScreen');
  }

  function showInventoryMenu() {
    hideAllScreens();
    const s = document.getElementById('inventoryMenuScreen');
    s.style.display = 'block';
    s.classList.add('active');
    stopCamera();
    stopQRCamera();
    stopOrderQRCamera();
    navigateToScreen('inventoryMenuScreen');
  }

  function showOrderMenu() {
    hideAllScreens();
    const s = document.getElementById('orderMenuScreen');
    s.style.display = 'block';
    s.classList.add('active');
    stopCamera();
    stopQRCamera();
    stopOrderQRCamera();
  }

  function showSearchMenu() {
    hideAllScreens();
    const s = document.getElementById('searchMenuScreen');
    s.style.display = 'block';
    s.classList.add('active');
    stopCamera();
    stopQRCamera();
    stopOrderQRCamera();
    navigateToScreen('searchMenuScreen');
  }

  function showOrderMain() {
    hideAllScreens();
    const s = document.getElementById('orderMainScreen');
    s.style.display = 'block';
    s.classList.add('active');
    stopCamera();
    stopQRCamera();
    stopOrderQRCamera();
    
    // ë””ë²„ê·¸ ë¡œê·¸ ì´ˆê¸°í™”
    clearOrderDebugLog();
    orderDebugLog('ì£¼ë¬¸ì„œ ë©”ì¸ í™”ë©´ ë¡œë“œ ì‹œì‘');

    // ì˜¤ëŠ˜ ë‚ ì§œ í‘œì‹œ
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth() + 1;
    const day = today.getDate();      
    orderDebugLog('ì˜¤ëŠ˜ ë‚ ì§œ: ' + year + 'ë…„ ' + month + 'ì›” ' + day + 'ì¼');

    document.getElementById('todayDateText').textContent = `${year}ë…„ ${month}ì›” ${day}ì¼`;
    
    // ì¡°íšŒ ì…ë ¥ í•„ë“œì— ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ë³¸ê°’ ì„¤ì •
    document.getElementById('searchOrderYear').value = year;
    document.getElementById('searchOrderMonth').value = month;
    document.getElementById('searchOrderDay').value = day;
    
    // ì˜¤ëŠ˜ ìƒì„±ëœ ì£¼ë¬¸ì„œ ìˆ˜ ì¡°íšŒ
    const orderDate = year.toString() + month.toString().padStart(2, '0') + day.toString().padStart(2, '0');
    orderDebugLog('ì£¼ë¬¸ ë‚ ì§œ ë¬¸ìì—´: ' + orderDate);
    orderDebugLog('ì„œë²„ì— getNewOrderIndex ìš”ì²­ ì¤‘...');

    google.script.run
      .withSuccessHandler(function(result) {
        orderDebugLog('ì„œë²„ ì‘ë‹µ ë°›ìŒ', 'success');
        orderDebugLog('result.success: ' + result.success);
        orderDebugLog('result.orderIndex: ' + result.orderIndex);
        orderDebugLog('result.existingOrders: ' + result.existingOrders);

        if (result.success) {
          const existingCount = result.existingOrders || 0;
          const nextIndex = result.orderIndex || 1;
          orderDebugLog('ê¸°ì¡´ ì£¼ë¬¸ì„œ ê°œìˆ˜: ' + existingCount, 'success');
          orderDebugLog('ë‹¤ìŒ ì£¼ë¬¸ì„œ ë²ˆí˜¸: ' + nextIndex, 'success');

          document.getElementById('todayOrderCount').textContent = existingCount;

          // ë§ˆì§€ë§‰ ì£¼ë¬¸ì„œ ë²ˆí˜¸ë¥¼ ì¡°íšŒ ì…ë ¥ í•„ë“œì— ê¸°ë³¸ê°’ìœ¼ë¡œ (ì—†ìœ¼ë©´ ë¹„ì›Œë‘ )
          if (result.orderIndex > 1) {
            const lastOrderIndex = nextIndex - 1;
            orderDebugLog('ë§ˆì§€ë§‰ ì£¼ë¬¸ì„œ ë²ˆí˜¸: ' + lastOrderIndex);
            document.getElementById('searchOrderIndex').value = result.orderIndex - 1;
          } else {
            orderDebugLog('ìƒì„±ëœ ì£¼ë¬¸ì„œ ì—†ìŒ');
            document.getElementById('searchOrderIndex').value = '';
          }
        } else {
          orderDebugLog('ì„œë²„ ì‘ë‹µ ì‹¤íŒ¨: ' + result.message, 'error');
          document.getElementById('todayOrderCount').textContent = '0';
          document.getElementById('searchOrderIndex').value = '';
        }
      })
      .withFailureHandler(function(error) {
        orderDebugLog('ì„œë²„ ìš”ì²­ ì‹¤íŒ¨: ' + error, 'error');
        document.getElementById('todayOrderCount').textContent = '?';
        console.error('ì˜¤ëŠ˜ ì£¼ë¬¸ì„œ ìˆ˜ ì¡°íšŒ ì‹¤íŒ¨:', error);
      })
      .getNewOrderIndex(orderDate);

      navigateToScreen('orderMainScreen');
  }

  function showNewOrderForm() {
    hideAllScreens();
    const s = document.getElementById('orderFormScreen');
    s.style.display = 'block';
    s.classList.add('active');
    
    // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¤ì •
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth() + 1;
    const day = today.getDate();
    
    const orderDate = year.toString() + month.toString().padStart(2, '0') + day.toString().padStart(2, '0');
    
    // ë‚ ì§œ í…ìŠ¤íŠ¸ í‘œì‹œ
    document.getElementById('newOrderDateText').textContent = `${year}ë…„ ${month}ì›” ${day}ì¼`;
    
    // ì‹ ê·œ ì£¼ë¬¸ì„œ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          document.getElementById('newOrderIndexText').textContent = result.orderIndex;
          // ë‚´ë¶€ì ìœ¼ë¡œ ì‚¬ìš©í•  ê°’ ì €ì¥
          window.currentOrderDate = orderDate;
          window.currentOrderIndex = result.orderIndex;
        }
      })
      .getNewOrderIndex(orderDate);
    
    // ì´ˆê¸°í™”
    orderItems = [];
    document.getElementById('orderItemsBody').innerHTML = '';
    document.getElementById('orderSearchInput').value = '';
    document.getElementById('orderMessage').innerHTML = '';
    currentOrderType = 'b2c';
    document.querySelector('input[name="orderType"][value="b2c"]').checked = true;

    // Focus on search input after a short delay
    setTimeout(() => {
      document.getElementById('orderSearchInput').focus();
    }, 100);

    navigateToScreen('orderFormScreen');
  }

  function handleOrderSearchEnter(event) {
    if (event.key === 'Enter' || event.keyCode === 13) {
      event.preventDefault();
      searchItemForOrder();
    }
  }

  function searchOrder() {
    const year = document.getElementById('searchOrderYear').value;
    const month = String(document.getElementById('searchOrderMonth').value).padStart(2, '0');  // âœ… String() ì¶”ê°€
    const day = String(document.getElementById('searchOrderDay').value).padStart(2, '0');  // âœ… String() ì¶”ê°€
    const orderIndexInput = document.getElementById('searchOrderIndex').value.trim();
    
    if (!year || !month || !day) {
      alert('ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    const orderDate = year + month + day;
    
    // ì£¼ë¬¸ì„œ ë²ˆí˜¸ê°€ ë¹„ì–´ìˆìœ¼ë©´ ì „ì²´ ì¡°íšŒ
    if (!orderIndexInput || orderIndexInput === '') {
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            hideAllScreens();
            const s = document.getElementById('orderViewScreen');
            s.style.display = 'block';
            s.classList.add('active');
            displayOrderList(orderDate, result.orderList);
            navigateToScreen('orderViewScreen');
          } else {
            alert(result.message);
          }
        })
        .withFailureHandler(function(error) {
          alert('ì£¼ë¬¸ì„œ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜: ' + error);
        })
        .getOrderListByDate(orderDate);
    } else {
      // ê°œë³„ ì¡°íšŒ
      const orderIndex = parseInt(orderIndexInput);
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            hideAllScreens();
            const s = document.getElementById('orderViewScreen');
            s.style.display = 'block';
            s.classList.add('active');
            displayOrderView(result.orders);
            navigateToScreen('orderViewScreen');
          } else {
            alert(result.message);
          }
        })
        .withFailureHandler(function(error) {
          alert('ì£¼ë¬¸ì„œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜: ' + error);
        })
        .getOrderData(orderDate, orderIndex);
    }
  }

  function displayOrderView(orders) {
    // ì£¼ë¬¸ì„œ ì •ë³´ ì¶”ì¶œ
    const orderSerialNumber = orders[0].serialNumber;
    const orderDateStr = orders[0].date.toString();
    const year = orderDateStr.substring(0, 4);
    const month = orderDateStr.substring(4, 6);
    const day = orderDateStr.substring(6, 8);
    const formattedDate = year + 'ë…„ ' + parseInt(month) + 'ì›” ' + parseInt(day) + 'ì¼';

    // ì£¼ë¬¸ ì‹œê°„ í¬ë§·íŒ…
    const orderTime = orders[0].time || '-';
    const payType = orders[0].payType || '-';
    const isCanceled = orders[0].isCanceled === true;

    // í•©ê³„ ê³„ì‚°
    let totalAmount = 0;
    let totalQty = 0;
    orders.forEach(function(order) {
      totalAmount += order.totalCost || 0;
      totalQty += order.cnt || 0;
    });

    // âœ… NEW: Modern white card style
    let html = '';

    // Header card
    if (isCanceled) {
      html += '<div style="background: white; padding: 30px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04); border: 2px solid #fee2e2; border-left: 5px solid #dc2626;">';
      html += '<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">';
      html += '<span style="font-size: 42px;">âŒ</span>';
      html += '<div>';
      html += '<h2 style="font-size: 38px; color: #2c3e50; margin: 0; font-weight: 700;">ì£¼ë¬¸ì„œ ìƒì„¸ ì •ë³´</h2>';
      html += '<div style="background: #fee2e2; color: #dc2626; display: inline-block; padding: 6px 12px; border-radius: 6px; font-weight: 600; font-size: 18px; margin-top: 8px;">ì·¨ì†Œëœ ì£¼ë¬¸</div>';
      html += '</div>';
      html += '</div>';
    } else {
      html += '<div style="background: white; padding: 30px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04); border: 2px solid #e8ecef; border-left: 5px solid #3498db;">';
      html += '<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">';
      html += '<span style="font-size: 42px;">ğŸ“‹</span>';
      html += '<h2 style="font-size: 38px; color: #2c3e50; margin: 0; font-weight: 700;">ì£¼ë¬¸ì„œ ìƒì„¸ ì •ë³´</h2>';
      html += '</div>';
    }
    
    // Order info grid
    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-top: 20px;">';
    html += '<div style="background: #f8f9fa; padding: 16px; border-radius: 12px;">';
    html += '<div style="color: #7f8c8d; font-size: 16px; margin-bottom: 6px;">ì£¼ë¬¸ì„œ ë²ˆí˜¸</div>';
    html += '<div style="color: #2c3e50; font-size: 22px; font-weight: 600; font-family: monospace;">' + orderSerialNumber + '</div>';
    html += '</div>';
    
    html += '<div style="background: #f8f9fa; padding: 16px; border-radius: 12px;">';
    html += '<div style="color: #7f8c8d; font-size: 16px; margin-bottom: 6px;">ì£¼ë¬¸ ë‚ ì§œ</div>';
    html += '<div style="color: #2c3e50; font-size: 22px; font-weight: 600;">' + formattedDate + '</div>';
    html += '</div>';
    
    html += '<div style="background: #f8f9fa; padding: 16px; border-radius: 12px;">';
    html += '<div style="color: #7f8c8d; font-size: 16px; margin-bottom: 6px;">ì£¼ë¬¸ ì‹œê°„</div>';
    html += '<div style="color: #2c3e50; font-size: 22px; font-weight: 600;">' + orderTime + '</div>';
    html += '</div>';
    
    html += '<div style="background: #f8f9fa; padding: 16px; border-radius: 12px;">';
    html += '<div style="color: #7f8c8d; font-size: 16px; margin-bottom: 6px;">ê²°ì œ ë°©ë²•</div>';
    html += '<div style="color: #2c3e50; font-size: 22px; font-weight: 600;">' + payType + '</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';

    // Items section
    html += '<div style="background: white; padding: 30px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04); border: 2px solid #e8ecef;">';
    html += '<h3 style="font-size: 24px; color: #2c3e50; margin-bottom: 20px; font-weight: 600;">ì£¼ë¬¸ í’ˆëª© ëª©ë¡</h3>';
    html += '<div style="overflow-x: auto;">';
    html += '<table class="order-table" id="orderViewTable">';
    html += '<thead>';
    html += '<tr style="border-bottom: none;">';
    html += '<th rowspan="2" style="vertical-align: middle; width: 20%;">ì½”ë“œë²ˆí˜¸</th>';
    html += '<th style="padding-bottom: 8px; width: 40%;">í’ˆëª…</th>';
    html += '<th style="padding-bottom: 8px; width: 20%;">íƒ€ì…</th>';
    html += '<th style="padding-bottom: 8px; width: 20%;">ê°œìˆ˜</th>';
    html += '</tr>';
    html += '<tr>';
    html += '<th style="padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">ì„¤ëª…</th>';
    html += '<th style="padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">ê°€ê²©</th>';
    html += '<th style="padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">ì´ê°€ê²©</th>';
    html += '</tr>';
    html += '</thead>';
    html += '<tbody id="orderViewBody"></tbody>';
    html += '</table>';
    html += '</div>';
    html += '</div>';

    // Summary section
    const summaryBorderColor = isCanceled ? '#fee2e2' : '#e3f2fd';
    html += '<div style="background: white; padding: 30px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04); border: 2px solid ' + summaryBorderColor + ';">';
    html += '<h3 style="font-size: 24px; color: #2c3e50; margin-bottom: 20px; font-weight: 600;">ì£¼ë¬¸ ìš”ì•½</h3>';
    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">';
    
    html += '<div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">';
    html += '<div style="color: #7f8c8d; font-size: 16px; margin-bottom: 8px;">ì´ ì£¼ë¬¸ ê¸ˆì•¡</div>';
    html += '<div style="color: #3498db; font-size: 32px; font-weight: 700;">' + totalAmount.toLocaleString() + 'ì›</div>';
    html += '</div>';
    
    html += '<div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">';
    html += '<div style="color: #7f8c8d; font-size: 16px; margin-bottom: 8px;">ì´ í’ˆëª© ìˆ˜</div>';
    html += '<div style="color: #2c3e50; font-size: 32px; font-weight: 700;">' + orders.length + 'ê°œ</div>';
    html += '</div>';
    
    html += '<div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">';
    html += '<div style="color: #7f8c8d; font-size: 16px; margin-bottom: 8px;">ì´ ìˆ˜ëŸ‰</div>';
    html += '<div style="color: #2c3e50; font-size: 32px; font-weight: 700;">' + totalQty + 'ê°œ</div>';
    html += '</div>';
    
    html += '</div>';
    html += '</div>';

    // Cancel button
    if (!isCanceled) {
      html += '<button class="btn btn-secondary" onclick="confirmCancelOrder(\'' + orderSerialNumber + '\')" style="margin-top: 0;">';
      html += '<span>âŒ</span> ì£¼ë¬¸ ì·¨ì†Œí•˜ê¸°';
      html += '</button>';
    }

    document.getElementById('orderViewContent').innerHTML = html;

    const tbody = document.getElementById('orderViewBody');
    orders.forEach(function(order) {
      const cost = order.isB2B === 1 ? order.costB2B : order.costB2C;

      // First row
      const row1 = tbody.insertRow();
      row1.style.borderBottom = 'none';
      row1.innerHTML = '<td rowspan="2" style="vertical-align: middle; font-weight: 600; font-size: 20px;">' + 
        order.codeNum + 
        '</td>' +
        '<td style="font-size: 20px; font-weight: 600; text-align: left; padding: 15px 15px 5px 15px;">' + 
        order.name + 
        '</td>' +
        '<td style="padding: 15px 10px 5px 10px; text-align: center;">' + 
        (order.isB2B === 1 ? 'ë„' : 'ì†Œ') + 
        '</td>' +
        '<td style="vertical-align: middle; font-size: 20px; text-align: center; padding: 15px 10px 5px 10px;">' + 
        order.cnt + 
        '</td>';
      
      // Second row
      const row2 = tbody.insertRow();
      row2.style.borderBottom = '2px solid #ddd';
      row2.innerHTML = '<td style="text-align: left; padding: 5px 15px 15px 15px; font-size: 18px; color: #666;">' + 
        (order.description || '-') + 
        '</td>' +
        '<td style="padding: 5px 15px 15px 15px; text-align: center;">' +
        '<strong style="color: #3498db; font-size: 20px;">' + cost.toLocaleString() + 'ì›</strong>' +
        '</td>' +
        '<td style="padding: 5px 15px 15px 15px; text-align: center;">' +
        '<strong style="color: #3498db; font-size: 20px;">' + order.totalCost.toLocaleString() + 'ì›</strong>' +
        '</td>';
    });
  }

  // ===== NEW FUNCTION: Cancel Order =====
  function confirmCancelOrder(orderSerialNumber) {
    if (confirm('ì •ë§ë¡œ ì´ ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì£¼ë¬¸ë²ˆí˜¸: ' + orderSerialNumber + '\n\nì¬ê³ ê°€ ë³µì›ë©ë‹ˆë‹¤.')) {
      cancelOrderById(orderSerialNumber);
    }
  }

  function cancelOrderById(orderSerialNumber) {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          alert('ì£¼ë¬¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì·¨ì†Œëœ í’ˆëª© ìˆ˜: ' + result.canceledRows + 'ê°œ\nì¬ê³ ê°€ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.');
          // Reload the order view to show updated status
          const dateStr = orderSerialNumber.substring(0, 8);
          const indexStr = parseInt(orderSerialNumber.substring(8));
          
          google.script.run
            .withSuccessHandler(function(result) {
              if (result.success) {
                displayOrderView(result.orders);
              }
            })
            .getOrderData(dateStr, indexStr);
        } else {
          alert('ì£¼ë¬¸ ì·¨ì†Œ ì‹¤íŒ¨:\n' + result.message);
        }
      })
      .withFailureHandler(function(error) {
        alert('ì£¼ë¬¸ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:\n' + error);
      })
      .cancelOrder(orderSerialNumber);
  }

  function displayOrderList(orderDate, orderList) {
    const dateStr = orderDate.toString();
    const year = dateStr.substring(0, 4);
    const month = dateStr.substring(4, 6);
    const day = dateStr.substring(6, 8);
    const formattedDate = `${year}ë…„ ${parseInt(month)}ì›” ${parseInt(day)}ì¼`;
    
    // âœ… ëª¨ë“  ì£¼ë¬¸ì„œ ë°ì´í„° í•œë²ˆì— ê°€ì ¸ì˜¤ê¸°
    let loadedCount = 0;
    const allOrders = [];
    
    orderList.forEach(index => {
      google.script.run
        .withSuccessHandler(function(result) {
          loadedCount++;
          
          if (result.success) {
            allOrders.push({
              index: index,
              orders: result.orders
            });
          }
          
          // ëª¨ë“  ì£¼ë¬¸ì„œ ë¡œë“œ ì™„ë£Œ
          if (loadedCount === orderList.length) {
            // ì¸ë±ìŠ¤ ìˆœì„œëŒ€ë¡œ ì •ë ¬
            allOrders.sort((a, b) => a.index - b.index);
            displayAllOrders(orderDate, formattedDate, allOrders);
          }
        })
        .withFailureHandler(function(error) {
          loadedCount++;
          console.error(`ì£¼ë¬¸ì„œ #${index} ì¡°íšŒ ì‹¤íŒ¨:`, error);
        })
        .getOrderData(orderDate, index);
    });
  }

  function displayAllOrders(orderDate, formattedDate, allOrders) {
    let totalAmount = 0;
    let totalItems = 0;
    let totalQty = 0;
    
    // Calculate totals
    allOrders.forEach(function(orderGroup) {
      orderGroup.orders.forEach(function(order) {
        totalAmount += order.totalCost || 0;
        totalQty += order.cnt || 0;
      });
      totalItems += orderGroup.orders.length;
    });
    
    // Header
    let html = '<div style="background: white; padding: 30px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04); border: 2px solid #e8ecef; border-left: 5px solid #3498db;">';
    html += '<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">';
    html += '<span style="font-size: 42px;">ğŸ“‹</span>';
    html += '<div>';
    html += '<h2 style="font-size: 38px; color: #2c3e50; margin: 0; font-weight: 700;">ì „ì²´ ì£¼ë¬¸ì„œ ëª©ë¡</h2>';
    html += '<div style="color: #7f8c8d; font-size: 18px; margin-top: 8px;">ğŸ“… ' + formattedDate + ' Â· ì´ <strong style="color: #3498db;">' + allOrders.length + '</strong>ê°œ ì£¼ë¬¸ì„œ</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // Display each order
    allOrders.forEach(function(orderGroup) {
      const orderSerialNumber = orderGroup.orders[0].serialNumber;
      const orderTime = orderGroup.orders[0].time || '-';
      const payType = orderGroup.orders[0].payType || '-';
      const isCanceled = orderGroup.orders[0].isCanceled === true;
      let orderAmount = 0;
      let orderQty = 0;
      
      orderGroup.orders.forEach(function(order) {
        orderAmount += order.totalCost || 0;
        orderQty += order.cnt || 0;
      });

      // âœ… NEW: Modern card style
      const cardBorder = isCanceled ? 'border: 2px solid #fee2e2; border-left: 5px solid #dc2626;' : 'border: 2px solid #e8ecef; border-left: 5px solid #3498db;';
      const titleColor = isCanceled ? '#dc2626' : '#2c3e50';
      const accentColor = isCanceled ? '#dc2626' : '#3498db';

      html += '<div style="background: white; ' + cardBorder + ' padding: 25px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);">';
      
      // Header with cancel badge or button
      html += '<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">';
      html += '<div>';
      html += '<h3 style="font-size: 28px; color: ' + titleColor + '; margin: 0 0 8px 0; font-weight: 700;">';
      html += 'ì£¼ë¬¸ì„œ #' + orderGroup.index;
      html += '</h3>';
      html += '<div style="font-family: monospace; color: #7f8c8d; font-size: 16px;">' + orderSerialNumber + '</div>';
      html += '</div>';
      
      if (isCanceled) {
        html += '<div style="background: #fee2e2; color: #dc2626; padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 16px; white-space: nowrap; height: fit-content;">âŒ ì·¨ì†Œë¨</div>';
      } else {
        html += '<button class="btn btn-secondary btn-small" onclick="confirmCancelOrderFromList(\'' + orderSerialNumber + '\', \'' + orderDate + '\')" style="margin: 0; white-space: nowrap; height: fit-content;">âŒ ì·¨ì†Œ</button>';
      }
      html += '</div>';
      
      // âœ… NEW: Simple text info (removed card-style grid)
      html += '<div style="color: #7f8c8d; font-size: 18px; line-height: 1.8; margin-bottom: 20px;">';
      html += 'ì£¼ë¬¸ ì‹œê°„: <strong style="color: #2c3e50;">' + orderTime + '</strong><br>';
      html += 'ê²°ì œ ë°©ë²•: <strong style="color: #2c3e50;">' + payType + '</strong><br>';
      html += 'ì£¼ë¬¸ ê¸ˆì•¡: <strong style="color: ' + accentColor + ';">' + orderAmount.toLocaleString() + 'ì›</strong>';
      html += '</div>';
      
      html += '<div style="overflow-x: auto;">';
      html += '<table class="order-table">';
      html += '<thead>';
      html += '<tr style="border-bottom: none;">';
      html += '<th rowspan="2" style="vertical-align: middle; width: 15%;">ì½”ë“œë²ˆí˜¸</th>';
      html += '<th style="padding-bottom: 8px; width: 35%;">í’ˆëª…</th>';
      html += '<th style="padding-bottom: 8px; width: 20%;">íƒ€ì…</th>';
      html += '<th style="padding-bottom: 8px; width: 15%;">ê°œìˆ˜</th>';
      html += '</tr>';
      html += '<tr>';
      html += '<th style="padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">ì„¤ëª…</th>';
      html += '<th style="padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">ê°€ê²©</th>';
      html += '<th style="padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">ì´ê°€ê²©</th>';
      html += '</tr>';
      html += '</thead>';
      html += '<tbody>';
      
      orderGroup.orders.forEach(function(order) {
        const cost = order.isB2B === 1 ? order.costB2B : order.costB2C;
        const textStyle = isCanceled ? 'text-decoration: line-through; opacity: 0.5;' : '';
      
        // First row
        html += '<tr style="border-bottom: none;">';
        html += '<td rowspan="2" style="vertical-align: middle; font-weight: 600; font-size: 18px; ' + textStyle + '">';
        html += order.codeNum;
        html += '</td>';
        html += '<td style="font-size: 18px; font-weight: 600; text-align: left; padding: 15px 15px 5px 15px; ' + textStyle + '">';
        html += order.name;
        html += '</td>';
        html += '<td style="padding: 15px 10px 5px 10px; text-align: center; ' + textStyle + '">';
        html += order.isB2B === 1 ? 'ë„' : 'ì†Œ';
        html += '</td>';
        html += '<td style="vertical-align: middle; font-size: 18px; text-align: center; padding: 15px 10px 5px 10px; ' + textStyle + '">';
        html += order.cnt;
        html += '</td>';
        html += '</tr>';
        
        // Second row
        html += '<tr style="border-bottom: 2px solid #ddd;">';
        html += '<td style="text-align: left; padding: 5px 15px 15px 15px; font-size: 16px; color: #666; ' + textStyle + '">';
        html += order.description || '-';
        html += '</td>';
        html += '<td style="padding: 5px 15px 15px 15px; text-align: center; ' + textStyle + '">';
        html += '<strong style="color: ' + accentColor + '; font-size: 18px;">' + cost.toLocaleString() + 'ì›</strong>';
        html += '</td>';
        html += '<td style="padding: 5px 15px 15px 15px; text-align: center; ' + textStyle + '">';
        html += '<strong style="color: ' + accentColor + '; font-size: 18px;">' + order.totalCost.toLocaleString() + 'ì›</strong>';
        html += '</td>';
        html += '</tr>';
      });
      
      html += '</tbody>';
      html += '</table>';
      html += '</div>';
      html += '</div>';
    });
    
    // Summary card
    html += '<div style="background: white; padding: 30px; border-radius: 16px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04); border: 2px solid #e3f2fd; border-left: 5px solid #3498db;">';
    html += '<h3 style="font-size: 24px; color: #2c3e50; margin-bottom: 20px; font-weight: 600;">ğŸ“Š ì „ì²´ í•©ê³„</h3>';
    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">';
    
    html += '<div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">';
    html += '<div style="color: #7f8c8d; font-size: 16px; margin-bottom: 8px;">ì´ ì£¼ë¬¸ ê¸ˆì•¡</div>';
    html += '<div style="color: #3498db; font-size: 32px; font-weight: 700;">' + totalAmount.toLocaleString() + 'ì›</div>';
    html += '</div>';
    
    html += '<div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">';
    html += '<div style="color: #7f8c8d; font-size: 16px; margin-bottom: 8px;">ì´ í’ˆëª© ìˆ˜</div>';
    html += '<div style="color: #2c3e50; font-size: 32px; font-weight: 700;">' + totalItems + 'ê°œ</div>';
    html += '</div>';
    
    html += '<div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">';
    html += '<div style="color: #7f8c8d; font-size: 16px; margin-bottom: 8px;">ì´ ìˆ˜ëŸ‰</div>';
    html += '<div style="color: #2c3e50; font-size: 32px; font-weight: 700;">' + totalQty + 'ê°œ</div>';
    html += '</div>';
    
    html += '</div>';
    html += '</div>';
    
    document.getElementById('orderViewContent').innerHTML = html;
  }

  // ===== NEW FUNCTION: Cancel order from list view =====
  function confirmCancelOrderFromList(orderSerialNumber, orderDate) {
    if (confirm('ì •ë§ë¡œ ì´ ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì£¼ë¬¸ë²ˆí˜¸: ' + orderSerialNumber + '\n\nì¬ê³ ê°€ ë³µì›ë©ë‹ˆë‹¤.')) {
      cancelOrderAndRefreshList(orderSerialNumber, orderDate);
    }
  }

  function cancelOrderAndRefreshList(orderSerialNumber, orderDate) {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          alert('ì£¼ë¬¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì·¨ì†Œëœ í’ˆëª© ìˆ˜: ' + result.canceledRows + 'ê°œ\nì¬ê³ ê°€ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.');
          
          // âœ… Reload the entire order list to show updated status
          google.script.run
            .withSuccessHandler(function(listResult) {
              if (listResult.success) {
                hideAllScreens();
                const s = document.getElementById('orderViewScreen');
                s.style.display = 'block';
                s.classList.add('active');
                displayOrderList(orderDate, listResult.orderList);
              }
            })
            .withFailureHandler(function(error) {
              alert('ì£¼ë¬¸ ëª©ë¡ ìƒˆë¡œê³ ì¹¨ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:\n' + error);
            })
            .getOrderListByDate(orderDate);
        } else {
          alert('ì£¼ë¬¸ ì·¨ì†Œ ì‹¤íŒ¨:\n' + result.message);
        }
      })
      .withFailureHandler(function(error) {
        alert('ì£¼ë¬¸ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:\n' + error);
      })
      .cancelOrder(orderSerialNumber);
  }

  function updateOrderType() {
    const type = document.querySelector('input[name="orderType"]:checked').value;
    currentOrderType = type;
    renderOrderItems();
  }

  function searchItemForOrder() {
    const codeNum = document.getElementById('orderSearchInput').value.trim();
    
    if (!codeNum) {
      showOrderMessage('ì½”ë“œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
      return;
    }
    
    showOrderMessage('ê²€ìƒ‰ ì¤‘...', 'info');
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          addItemToOrder(result.item);
          document.getElementById('orderSearchInput').value = '';
          
          // Keep focus on search input
          setTimeout(() => {
            document.getElementById('orderSearchInput').focus();
          }, 100);
        } else {
          showOrderMessage(result.message, 'error');

          // Keep focus on search input
          setTimeout(() => {
            document.getElementById('orderSearchInput').focus();
          }, 100);
        }
      })
      .withFailureHandler(function(error) {
        showOrderMessage('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜: ' + error, 'error');

        // Keep focus on search input
        setTimeout(() => {
          document.getElementById('orderSearchInput').focus();
        }, 100);
      })
      .searchByCodeNum(codeNum);
  }

  function addItemToOrder(item) {
    // ì¬ê³  í™•ì¸
    if (item.stockNum <= 0) {
      showOrderMessage('ì¬ê³ ê°€ ì—†ìŠµë‹ˆë‹¤: ' + item.name, 'error');
      return;
    }
    
    // ì¤‘ë³µ í™•ì¸
    const existingItem = orderItems.find(i => i.codeNum === item.codeNum);
    
    if (existingItem) {
      // ì¬ê³  ì´ˆê³¼ í™•ì¸
      if (existingItem.cnt + 1 > item.stockNum) {
        showOrderMessage('ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. í˜„ì¬ ì¬ê³ : ' + item.stockNum, 'error');
        return;
      }
      existingItem.cnt++;
    } else {
      orderItems.push({
        codeNum: item.codeNum,
        name: item.name,
        description: item.description,
        costB2B: item.costB2B,
        costB2C: item.costB2C,
        stockNum: item.stockNum,
        cnt: 1,
        isB2B: currentOrderType === 'b2b'
      });
    }
    
    renderOrderItems();
    showOrderMessage('í’ˆëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤: ' + item.name, 'success');
  }

  function renderOrderItems() {
    const tbody = document.getElementById('orderItemsBody');
    tbody.innerHTML = '';
    
    orderItems.forEach((item, index) => {
      const cost = item.isB2B ? item.costB2B : item.costB2C;
      
      // âœ… ì²« ë²ˆì§¸ í–‰ (ì½”ë“œë²ˆí˜¸, í’ˆëª…, íƒ€ì…, ê°œìˆ˜, ì‚­ì œ)
      const row1 = tbody.insertRow();
      row1.style.borderBottom = 'none';
      row1.innerHTML = `
        <td rowspan="2" style="vertical-align: middle; font-weight: 600; font-size: 26px;">
          ${item.codeNum}
        </td>
        <td style="font-size: 26px; font-weight: 600; text-align: left; padding: 15px 15px 5px 15px;">
          ${item.name}
        </td>
        <td style="padding: 15px 10px 5px 10px;">
          <div style="display: flex; gap: 8px; align-items: center; justify-content: center;">
            <label style="font-size: 22px; margin: 0;">
              <input type="radio" name="itemType${index}" value="b2c" ${!item.isB2B ? 'checked' : ''} 
                    onchange="updateItemType(${index}, false)" style="width: 18px; height: 18px; vertical-align: middle;"> ì†Œ
            </label>
            <label style="font-size: 22px; margin: 0;">
              <input type="radio" name="itemType${index}" value="b2b" ${item.isB2B ? 'checked' : ''} 
                    onchange="updateItemType(${index}, true)" style="width: 18px; height: 18px; vertical-align: middle;"> ë„
            </label>
          </div>
        </td>
        <td rowspan="2" style="vertical-align: middle;">
          <div class="qty-control">
            <button class="qty-btn" onclick="decreaseQty(${index})">-</button>
            <input type="number" 
              class="qty-input" 
              value="${item.cnt}" 
              min="1" 
              max="${item.stockNum}"
              onchange="updateQty(${index}, this.value)"
              onclick="this.select()"
              style="width: 60px; text-align: center; font-size: 22px; font-weight: 600; border: 1px solid #ddd; border-radius: 4px; padding: 4px;">
            <button class="qty-btn" onclick="increaseQty(${index})">+</button>
          </div>
        </td>
        <td rowspan="2" style="vertical-align: middle;">
          <button class="delete-btn" onclick="removeItem(${index})">ì‚­ì œ</button>
        </td>
      `;
      
      // âœ… ë‘ ë²ˆì§¸ í–‰ (ì„¤ëª…, ê°€ê²©)
      const row2 = tbody.insertRow();
      row2.style.borderBottom = '2px solid #ddd';
      row2.innerHTML = `
        <td style="text-align: left; padding: 5px 15px 15px 15px; font-size: 24px; color: #666;">
          ${item.description || '-'}
        </td>
        <td style="padding: 5px 15px 15px 15px;">
          <strong style="color: #667eea; font-size: 26px;">${cost.toLocaleString()}ì›</strong>
        </td>
      `;
    });
  }

  function updateItemType(index, isB2B) {
    orderItems[index].isB2B = isB2B;
    renderOrderItems();

    // Keep focus on search input
    setTimeout(() => {
      document.getElementById('orderSearchInput').focus();
    }, 100);
  }

  function increaseQty(index) {
    const item = orderItems[index];
    if (item.cnt >= item.stockNum) {
      showOrderMessage('ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. í˜„ì¬ ì¬ê³ : ' + item.stockNum, 'error');
      return;
    }
    item.cnt++;
    renderOrderItems();

    // Keep focus on search input
    setTimeout(() => {
      document.getElementById('orderSearchInput').focus();
    }, 100);
  }

  function decreaseQty(index) {
    const item = orderItems[index];
    if (item.cnt > 1) {
      item.cnt--;
      renderOrderItems();
    }

    // Keep focus on search input
    setTimeout(() => {
      document.getElementById('orderSearchInput').focus();
    }, 100);
  }

  function updateQty(index, newValue) {
    const item = orderItems[index];
    const qty = parseInt(newValue);
    
    // Validate input
    if (isNaN(qty) || qty < 1) {
      showOrderMessage('ìˆ˜ëŸ‰ì€ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
      renderOrderItems();
      setTimeout(() => {
        document.getElementById('orderSearchInput').focus();
      }, 100);
      return;
    }
    
    if (qty > item.stockNum) {
      showOrderMessage('ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. í˜„ì¬ ì¬ê³ : ' + item.stockNum + 'ê°œ', 'error');
      renderOrderItems();
      setTimeout(() => {
        document.getElementById('orderSearchInput').focus();
      }, 100);
      return;
    }
    
    item.cnt = qty;
    renderOrderItems();
    setTimeout(() => {
      document.getElementById('orderSearchInput').focus();
    }, 100);
  }

  function removeItem(index) {
    orderItems.splice(index, 1);
    renderOrderItems();

    // Keep focus on search input
    setTimeout(() => {
      document.getElementById('orderSearchInput').focus();
    }, 100);
  }

  function submitOrder() {
    if (orderItems.length === 0) {
      showOrderMessage('ì£¼ë¬¸í•  í’ˆëª©ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.', 'error');
      return;
    }
    
    // ì €ì¥ëœ ë‚ ì§œì™€ ì¸ë±ìŠ¤ ì‚¬ìš©
    const orderDate = window.currentOrderDate;
    const orderIndex = window.currentOrderIndex;
    
    if (!orderDate || !orderIndex) {
      showOrderMessage('ë‚ ì§œì™€ ì£¼ë¬¸ì„œ ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
      return;
    }
    
    // âœ… NEW: Get selected payment type
    const payType = document.querySelector('input[name="payType"]:checked').value;

    const orderData = {
      date: parseInt(orderDate),
      index: orderIndex,
      payType: payType,  // âœ… NEW
      items: orderItems
    };
    
    // âœ… IDë¡œ ë²„íŠ¼ ì§ì ‘ ì°¸ì¡°
    const submitBtn = document.getElementById('submitOrderBtn');
    
    // ì›ë˜ ë‚´ìš© ì €ì¥
    const originalContent = submitBtn.innerHTML;
    
    // ë²„íŠ¼ ë¹„í™œì„±í™”
    submitBtn.disabled = true;
    submitBtn.style.opacity = '0.6';
    submitBtn.style.cursor = 'not-allowed';
    submitBtn.textContent = 'â³ ì£¼ë¬¸ ì§„í–‰ì¤‘...';  // textContent ì‚¬ìš©
    
    showOrderMessage('ì£¼ë¬¸ì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘...', 'info');
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          submitBtn.textContent = 'âœ… ì£¼ë¬¸ ì™„ë£Œ!';
          submitBtn.style.opacity = '1';
          showOrderMessage('ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
          
          setTimeout(() => {
            // ì£¼ë¬¸ì„œ ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            showOrderMain();
            
            // ë²„íŠ¼ ì¬í™œì„±í™”
            submitBtn.disabled = false;
            submitBtn.style.cursor = 'pointer';
            submitBtn.innerHTML = '<span>âœ…</span> ì£¼ë¬¸í•˜ê¸°';
          }, 2000);
        } else {
          submitBtn.disabled = false;
          submitBtn.style.opacity = '1';
          submitBtn.style.cursor = 'pointer';
          submitBtn.innerHTML = originalContent;
          showOrderMessage('ì£¼ë¬¸ ì‹¤íŒ¨: ' + result.message, 'error');

          // Keep focus on search input after error
          setTimeout(() => {
            document.getElementById('orderSearchInput').focus();
          }, 100);
        }
      })
      .withFailureHandler(function(error) {
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        submitBtn.style.cursor = 'pointer';
        submitBtn.innerHTML = originalContent;
        showOrderMessage('ì£¼ë¬¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ' + error, 'error');
      })
      .saveOrder(orderData);
  }

  function showOrderMessage(msg, type) {
    const msgDiv = document.getElementById('orderMessage');
    let className = 'alert-info';
    if (type === 'error') className = 'alert-error';
    if (type === 'success') className = 'alert-success';
    
    msgDiv.innerHTML = '<div class="alert ' + className + '">' + msg + '</div>';
    
    if (type === 'success' || type === 'error') {
      setTimeout(() => {
        msgDiv.innerHTML = '';
      }, 5000);
    }
  }

  // QR ìŠ¤ìºë„ˆ for ì£¼ë¬¸ì„œ
  function toggleOrderQRScanner() {
    const sc = document.getElementById('orderQRScannerContainer');
    const btnText = document.getElementById('orderQRBtnText');
    const captureBtn = document.getElementById('orderQRCaptureBtn');
    
    if (sc.style.display === 'block') {
      stopOrderQRCamera();
      btnText.textContent = 'QR ìŠ¤ìº”';
      captureBtn.style.display = 'none';
    } else {
      startOrderQRCamera();
    }
  }

  async function startOrderQRCamera() {
    await CameraModule.start('orderQR', {
      videoElement: document.getElementById('orderQRVideoElement'),
      containerElement: document.getElementById('orderQRScannerContainer'),
      buttonTextElement: document.getElementById('orderQRBtnText'),
      captureButtonElement: document.getElementById('orderQRCaptureBtn'),
      resultElement: document.getElementById('orderMessage')
    });
  }

  function stopOrderQRCamera() {
    CameraModule.stop('orderQR', {
      videoElement: document.getElementById('orderQRVideoElement'),
      containerElement: document.getElementById('orderQRScannerContainer'),
      captureButtonElement: document.getElementById('orderQRCaptureBtn'),
      buttonTextElement: document.getElementById('orderQRBtnText')
    });
  }

  async function captureOrderQR() {
    try {
      const imgData = CameraModule.captureImage(
        document.getElementById('orderQRVideoElement'),
        document.getElementById('orderQRCanvas')
      );
      
      showOrderMessage('QR ì½”ë“œ ì¸ì‹ ì¤‘...', 'info');
      
      if (typeof jsQR === 'undefined') {
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js';
        s.onload = () => {
          decodeOrderQR(imgData);
        };
        s.onerror = () => {
          showOrderMessage('QR ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        };
        document.head.appendChild(s);
      } else {
        decodeOrderQR(imgData);
      }
    } catch (e) {
      showOrderMessage('QR ì½”ë“œ ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
  }

  function decodeOrderQR(imgData) {
    try {
      const code = jsQR(imgData.data, imgData.width, imgData.height, {inversionAttempts: "dontInvert"});
      if (code) {
        document.getElementById('orderSearchInput').value = code.data;
        stopOrderQRCamera();
        showOrderMessage('QR ì½”ë“œ ì¸ì‹ ì„±ê³µ: ' + code.data, 'success');
        setTimeout(() => searchItemForOrder(), 500);
      } else {
        showOrderMessage('QR ì½”ë“œë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
      }
    } catch (e) {
      showOrderMessage('QR ì½”ë“œ ë””ì½”ë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
  }

  function showSearch() {
    hideAllScreens();
    const s = document.getElementById('searchScreen');
    s.style.display = 'block';
    s.classList.add('active');
    document.getElementById('barcodeInput').value = '';
    document.getElementById('searchResult').innerHTML = '';
    clearDebugLog();
    stopCamera();
    stopQRCamera();
    stopOrderQRCamera();
    navigateToScreen('searchScreen');
  }

  function showQRSearch() {
    hideAllScreens();
    const s = document.getElementById('qrSearchScreen');
    s.style.display = 'block';
    s.classList.add('active');
    const inputElement = document.getElementById('qrInput');
    inputElement.value = '';
    document.getElementById('qrSearchResult').innerHTML = '';
    clearQRDebugLog();
    stopCamera();
    stopQRCamera();
    stopOrderQRCamera();
    
    setTimeout(() => {
      inputElement.focus();
    }, 100);

    navigateToScreen('qrSearchScreen');
  }

  function showAllItems() {
    hideAllScreens();
    const s = document.getElementById('listScreen');
    s.style.display = 'block';
    s.classList.add('active');
    loadAllItems();
    navigateToScreen('listScreen');
  }

  function showGuide() {
    hideAllScreens();
    const s = document.getElementById('guideScreen');
    s.style.display = 'block';
    s.classList.add('active');
    stopCamera();
    stopQRCamera();
    stopOrderQRCamera();
    loadGuideImage();
    navigateToScreen('guideScreen');
  }

  function loadGuideImage() {
    var container = document.getElementById('guideImageContainer');
    // ì„œë²„ì—ì„œ GUIDE_IMAGE_ID ê°€ì ¸ì˜¤ê¸°
    google.script.run
      .withSuccessHandler(function(imageId) {
        if (!imageId) {
          container.innerHTML = '<div class="alert alert-error">ê°€ì´ë“œ ì´ë¯¸ì§€ IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br><br>ìŠ¤í¬ë¦½íŠ¸ ì†ì„±ì— GUIDE_IMAGE_IDë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.</div>';
          return;
        }
        
        var urls = [
          'https://drive.google.com/uc?export=download&id=' + imageId,
          'https://lh3.googleusercontent.com/d/' + imageId + '=s0',
          'https://drive.google.com/uc?id=' + imageId + '&export=download',
          'https://drive.google.com/uc?export=view&id=' + imageId
        ];
        
        var currentUrlIndex = 0;
        
        function tryNextUrl() {
          if (currentUrlIndex >= urls.length) {
            container.innerHTML = '<div class="alert alert-error">ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br><br><strong>í•´ê²° ë°©ë²•:</strong><br>1. Google Driveì—ì„œ ì´ë¯¸ì§€ ìš°í´ë¦­<br>2. \'ê³µìœ \' â†’ \'ë§í¬ ë³µì‚¬\'<br>3. ë§í¬ ê¶Œí•œ: "ë§í¬ê°€ ìˆëŠ” ëª¨ë“  ì‚¬ìš©ì"<br>4. íŒŒì¼ ID í™•ì¸: ' + imageId + '<br><br><a href="https://drive.google.com/file/d/' + imageId + '/view" target="_blank" style="color: #c33; text-decoration: underline; font-size: 24px;">ğŸ“‚ Google Driveì—ì„œ ì´ë¯¸ì§€ ì—´ê¸°</a></div>';
            return;
          }
          
          var img = new Image();
          var currentUrl = urls[currentUrlIndex];
          
          console.log('ì´ë¯¸ì§€ ë¡œë“œ ì‹œë„ (' + (currentUrlIndex + 1) + '/' + urls.length + '):', currentUrl);
          
          img.onload = function() {
            console.log('âœ“ ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ:', currentUrl);
            container.innerHTML = '<img src="' + currentUrl + '" alt="ë™ì‘ ê°€ì´ë“œ" class="guide-image">';
          };
          
          img.onerror = function() {
            console.log('âœ— ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ (' + (currentUrlIndex + 1) + '/' + urls.length + '):', currentUrl);
            currentUrlIndex++;
            setTimeout(tryNextUrl, 500);
          };
          
          img.src = currentUrl;
        }
        
        tryNextUrl();
      })
      .withFailureHandler(function(error) {
        container.innerHTML = '<div class="alert alert-error">ì´ë¯¸ì§€ IDë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error + '</div>';
      })
      .getGuideImageId();
  }

  let userIPCache = null;

  async function fetchUserIP() {
    if (userIPCache) {
      return userIPCache;
    }
    
    try {
      const response = await fetch('https://api.ipify.org?format=json');
      const data = await response.json();
      userIPCache = data.ip;
      console.log('âœ“ ì‚¬ìš©ì IP íšë“:', userIPCache);
      return userIPCache;
    } catch (error) {
      console.log('âœ— IP íšë“ ì‹¤íŒ¨, ëŒ€ì²´ ë°©ë²• ì‹œë„...');
      try {
        const response2 = await fetch('https://jsonip.com');
        const data2 = await response2.json();
        userIPCache = data2.ip;
        console.log('âœ“ ì‚¬ìš©ì IP íšë“ (ëŒ€ì²´):', userIPCache);
        return userIPCache;
      } catch (error2) {
        console.log('âœ— IP íšë“ ì™„ì „ ì‹¤íŒ¨');
        return 'Unknown';
      }
    }
  }

  window.addEventListener('load', function() {
    fetchUserIP();
    loadLatestRevision();
    // Set initial history state
    history.replaceState({ screen: 'mainScreen' }, '', '#mainScreen');
  });

  function searchBarcode() {
    const c = document.getElementById('barcodeInput').value.trim();
    if (!c) {
      showError('searchResult', 'ì½”ë“œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    showLoading('searchResult');
    
    google.script.run
      .withSuccessHandler(function(result) {
        displaySearchResult(result);
        if (result.success) {
          logCodeNumAccess(c);
        }
      })
      .withFailureHandler(e => showError('searchResult', 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜: ' + e))
      .searchByCodeNum(c);
  }
  
  async function logCodeNumAccess(codeNum) {
    const userIP = await fetchUserIP();
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          console.log('âœ“ ì ‘ê·¼ ë¡œê·¸ ê¸°ë¡ ì™„ë£Œ - IP:', userIP, 'ì½”ë“œë²ˆí˜¸:', codeNum);
        } else {
          console.log('âœ— ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨:', result.message);
        }
      })
      .withFailureHandler(function(error) {
        console.log('âœ— ë¡œê·¸ ê¸°ë¡ ì˜¤ë¥˜:', error);
      })
      .logAccess(codeNum, userIP);
  }

  function displaySearchResult(r) {
    const c = document.getElementById('searchResult');
    if (r.success) {
      const i = r.item;

      // Helper function to get stock status
      function getStockClass(stock) {
        if (stock === 0) return 'out';
        if (stock < 10) return 'low';
        if (stock < 50) return 'normal';
        return 'sufficient';
      }

      function getStockText(stock) {
        if (stock === 0) return 'í’ˆì ˆ';
        if (stock < 10) return 'ë¶€ì¡±';
        if (stock < 50) return 'ë³´í†µ';
        return 'ì¶©ë¶„';
      }

      const stockClass = getStockClass(i.stockNum ?? 0);
      const stockText = getStockText(i.stockNum ?? 0);

      // Header with name and stock badge
      html += '<div class="card-header">';
      html += '<h4>' + (i.name || '-') + '</h4>';
      html += '<span class="stock-badge ' + stockClass + '">' + stockText + '</span>';
      html += '</div>';
      
      // Description
      html += '<p class="description">' + (i.description || '-') + '</p>';
      
      // Info grid (2x2)
      html += '<div class="info-grid">';
      
      // Code number
      html += '<div>';
      html += '<span class="label">ì½”ë“œë²ˆí˜¸:</span> ';
      html += '<span class="value code">' + (i.codeNum || '-') + '</span>';
      html += '</div>';
      
      // Stock
      html += '<div>';
      html += '<span class="label">ì¬ê³ :</span> ';
      html += '<span class="value stock-value ' + stockClass + '">' + (i.stockNum ?? '-') + 'ê°œ</span>';
      html += '</div>';
      
      // B2B price
      html += '<div>';
      html += '<span class="label">ë„ë§¤ê°€:</span> ';
      html += '<span class="value">' + (i.costB2B ? i.costB2B.toLocaleString() + 'ì›' : '-') + '</span>';
      html += '</div>';
      
      // B2C price
      html += '<div>';
      html += '<span class="label">ì†Œë§¤ê°€:</span> ';
      html += '<span class="value">' + (i.costB2C ? i.costB2C.toLocaleString() + 'ì›' : '-') + '</span>';
      html += '</div>';
      
      html += '</div>'; // End info-grid
      html += '</div>'; // End item-card-new
      
      c.innerHTML = html;
    } else {
      showError('searchResult', r.message);
    }
  }

  function loadAllItems() {
    showLoading('itemList');
    google.script.run.withSuccessHandler(displayAllItems).withFailureHandler(e => showError('itemList', 'ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜: ' + e)).getAllItems();
  }

  function displayAllItems(r) {
    const c = document.getElementById('itemList');
    if (r.success) {
      allItems = r.items;
      if (allItems.length === 0) {
        c.innerHTML = '<div class="alert alert-info">ë“±ë¡ëœ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      renderItems(allItems);
    } else {
      showError('itemList', r.message);
    }
  }

  function renderItems(items) {
    const c = document.getElementById('itemList');
    if (items.length === 0) {
      c.innerHTML = '<div class="alert alert-info">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }
    
    // Helper function to get stock status
    function getStockClass(stock) {
      if (stock === 0) return 'out';
      if (stock < 10) return 'low';
      if (stock < 50) return 'normal';
      return 'sufficient';
    }
    
    function getStockText(stock) {
      if (stock === 0) return 'í’ˆì ˆ';
      if (stock < 10) return 'ë¶€ì¡±';
      if (stock < 50) return 'ë³´í†µ';
      return 'ì¶©ë¶„';
    }
    
    let html = '<div class="item-list">';
    items.forEach(function(i) {
      const stockClass = getStockClass(i.stockNum ?? 0);
      const stockText = getStockText(i.stockNum ?? 0);
      
      html += '<div class="item-card-new">';
      
      // Header with name and stock badge
      html += '<div class="card-header">';
      html += '<h4>' + (i.name || '-') + '</h4>';
      html += '<span class="stock-badge ' + stockClass + '">' + stockText + '</span>';
      html += '</div>';
      
      // Description
      html += '<p class="description">' + (i.description || '-') + '</p>';
      
      // Info grid (2x2)
      html += '<div class="info-grid">';
      
      // Code number
      html += '<div>';
      html += '<span class="label">ì½”ë“œë²ˆí˜¸:</span> ';
      html += '<span class="value code">' + (i.codeNum || '-') + '</span>';
      html += '</div>';
      
      // Stock
      html += '<div>';
      html += '<span class="label">ì¬ê³ :</span> ';
      html += '<span class="value stock-value ' + stockClass + '">' + (i.stockNum ?? '-') + 'ê°œ</span>';
      html += '</div>';
      
      // B2B price
      html += '<div>';
      html += '<span class="label">ë„ë§¤ê°€:</span> ';
      html += '<span class="value">' + (i.costB2B ? i.costB2B.toLocaleString() + 'ì›' : '-') + '</span>';
      html += '</div>';
      
      // B2C price
      html += '<div>';
      html += '<span class="label">ì†Œë§¤ê°€:</span> ';
      html += '<span class="value">' + (i.costB2C ? i.costB2C.toLocaleString() + 'ì›' : '-') + '</span>';
      html += '</div>';
      
      html += '</div>'; // End info-grid
      html += '</div>'; // End item-card-new
    });
    html += '</div>';
    
    c.innerHTML = html;
  }

  function filterItems() {
    const f = document.getElementById('filterInput').value.toLowerCase();
    const filtered = allItems.filter(i => i.name.toLowerCase().includes(f) || i.codeNum.toString().includes(f) || i.description.toLowerCase().includes(f) || i.serialNum.toString().includes(f));
    renderItems(filtered);
  }

  async function startCameraScan() {
    clearDebugLog();
    debugLog('ì¹´ë©”ë¼ ìŠ¤ìº” ì‹œì‘');
    
    await CameraModule.start('barcode', {
      videoElement: document.getElementById('videoElement'),
      containerElement: document.getElementById('scannerContainer'),
      buttonTextElement: document.getElementById('cameraBtnText'),
      captureButtonElement: document.getElementById('captureBtn'),
      resultElement: document.getElementById('searchResult')
    });
  }

  async function captureAndDecode() {
    debugLog('ë°”ì½”ë“œ ìº¡ì²˜ ì‹œì‘');
    
    try {
      // âœ… ì´ ë¶€ë¶„ì´ CameraModule.captureImage()ë¡œ êµì²´ë¨
      const imageData = CameraModule.captureImage(
        document.getElementById('videoElement'),
        document.getElementById('canvas')
      );
      debugLog('âœ“ ì´ë¯¸ì§€ ìº¡ì²˜ ì™„ë£Œ', 'success');
      const img = c.toDataURL('image/png');
      showLoading('searchResult');
      debugLog('Quagga ë°”ì½”ë“œ ì¸ì‹ ì‹œì‘...');
      
      Quagga.decodeSingle({src: img, numOfWorkers: 0, locate: true, decoder: {readers: ['code_39_reader', 'code_39_vin_reader', 'ean_8_reader', 'ean_reader', 'code_128_reader', 'codabar_reader', 'upc_reader', 'upc_e_reader', 'i2of5_reader']}}, function(r) {
        if (r && r.codeResult) {
          debugLog('âœ“ ë°”ì½”ë“œ ì¸ì‹ ì„±ê³µ: ' + r.codeResult.code, 'success');
          document.getElementById('barcodeInput').value = r.codeResult.code;
          stopCamera();
          document.getElementById('searchResult').innerHTML = '<div class="alert alert-info">âœ… ë°”ì½”ë“œ ì¸ì‹ ì„±ê³µ: <strong>' + r.codeResult.code + '</strong></div>';
          setTimeout(() => searchBarcode(), 500);
        } else {
          debugLog('âœ— ë°”ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ', 'error');
          showError('searchResult', 'ë°”ì½”ë“œë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>â€¢ ë°”ì½”ë“œë¥¼ ë…¹ìƒ‰ ì˜ì—­ì— ë§ì¶°ì£¼ì„¸ìš”<br>â€¢ ì¡°ëª…ì„ ë°ê²Œ í•´ì£¼ì„¸ìš”');
        }
      });
    } catch (e) {
      debugLog('âœ— ì˜¤ë¥˜: ' + e.message, 'error');
      showError('searchResult', 'ë°”ì½”ë“œ ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }

  function stopCamera() {
    debugLog('ì¹´ë©”ë¼ ë„ê¸°');
    CameraModule.stop('barcode', {
      videoElement: document.getElementById('videoElement'),
      containerElement: document.getElementById('scannerContainer'),
      captureButtonElement: document.getElementById('captureBtn'),
      buttonTextElement: document.getElementById('cameraBtnText')
    });
  }

  function searchQR() {
    const inputElement = document.getElementById('qrInput');
    const q = inputElement.value.trim();
    
    if (!q) {
      showError('qrSearchResult', 'QR ì½”ë“œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      inputElement.focus();
      return;
    }
    
    showLoading('qrSearchResult');
    
    google.script.run
      .withSuccessHandler(function(result) {
        displayQRSearchResult(result);
        inputElement.value = '';
        inputElement.focus();
        
        if (result.success) {
          logCodeNumAccess(q);
        }
      })
      .withFailureHandler(function(e) {
        showError('qrSearchResult', 'ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜: ' + e);
        inputElement.value = '';
        inputElement.focus();
      })
      .searchByCodeNum(q);
  }

  function displayQRSearchResult(r) {
    const c = document.getElementById('qrSearchResult');
    if (r.success) {
      const i = r.item;
      
      // Helper function to get stock status
      function getStockClass(stock) {
        if (stock === 0) return 'out';
        if (stock < 10) return 'low';
        if (stock < 50) return 'normal';
        return 'sufficient';
      }
      
      function getStockText(stock) {
        if (stock === 0) return 'í’ˆì ˆ';
        if (stock < 10) return 'ë¶€ì¡±';
        if (stock < 50) return 'ë³´í†µ';
        return 'ì¶©ë¶„';
      }

      const stockClass = getStockClass(i.stockNum ?? 0);
      const stockText = getStockText(i.stockNum ?? 0);
      
      let html = '<div class="item-card-new">';

      // Header with name and stock badge
      html += '<div class="card-header">';
      html += '<h4>' + (i.name || '-') + '</h4>';
      html += '<span class="stock-badge ' + stockClass + '">' + stockText + '</span>';
      html += '</div>';
      
      // Description
      html += '<p class="description">' + (i.description || '-') + '</p>';
      
      // Info grid (2x2)
      html += '<div class="info-grid">';
      
      // Code number
      html += '<div>';
      html += '<span class="label">ì½”ë“œë²ˆí˜¸:</span> ';
      html += '<span class="value code">' + (i.codeNum || '-') + '</span>';
      html += '</div>';
      
      // Stock
      html += '<div>';
      html += '<span class="label">ì¬ê³ :</span> ';
      html += '<span class="value stock-value ' + stockClass + '">' + (i.stockNum ?? '-') + 'ê°œ</span>';
      html += '</div>';
      
      // B2B price
      html += '<div>';
      html += '<span class="label">ë„ë§¤ê°€:</span> ';
      html += '<span class="value">' + (i.costB2B ? i.costB2B.toLocaleString() + 'ì›' : '-') + '</span>';
      html += '</div>';
      
      // B2C price
      html += '<div>';
      html += '<span class="label">ì†Œë§¤ê°€:</span> ';
      html += '<span class="value">' + (i.costB2C ? i.costB2C.toLocaleString() + 'ì›' : '-') + '</span>';
      html += '</div>';
      
      html += '</div>'; // End info-grid
      html += '</div>'; // End item-card-new
      
      c.innerHTML = html;
    } else {
      showError('qrSearchResult', r.message);
    }
  }

  async function startQRScan() {
    clearQRDebugLog();
    qrDebugLog('QR ìŠ¤ìº” ì‹œì‘');
    
    await CameraModule.start('qr', {
      videoElement: document.getElementById('qrVideoElement'),
      containerElement: document.getElementById('qrScannerContainer'),
      buttonTextElement: document.getElementById('qrBtnText'),
      captureButtonElement: document.getElementById('qrCaptureBtn'),
      resultElement: document.getElementById('qrSearchResult')
    });
  }

  async function captureAndDecodeQR() {
    qrDebugLog('QR ì½”ë“œ ìº¡ì²˜ ì‹œì‘');

    try {
      const imgData = CameraModule.captureImage(
        document.getElementById('qrVideoElement'),
        document.getElementById('qrCanvas')
      );
      
      qrDebugLog('âœ“ ì´ë¯¸ì§€ ìº¡ì²˜ ì™„ë£Œ', 'success');
      showLoading('qrSearchResult');
      qrDebugLog('jsQRë¡œ QR ì½”ë“œ ì¸ì‹ ì‹œì‘...');
      qrDebugLog('ImageData ì¶”ì¶œ ì™„ë£Œ');
      if (typeof jsQR === 'undefined') {
        qrDebugLog('jsQR ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë”© ì¤‘...');
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js';
        s.onload = () => {
          qrDebugLog('jsQR ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì™„ë£Œ');
          decodeQRFromImageData(imgData);
        };
        s.onerror = () => {
          qrDebugLog('âœ— jsQR ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì‹¤íŒ¨', 'error');
          showError('qrSearchResult', 'QR ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        };
        document.head.appendChild(s);
      } else {
        decodeQRFromImageData(imgData);
      }
    } catch (e) {
      qrDebugLog('âœ— ì˜¤ë¥˜: ' + e.message, 'error');
      showError('qrSearchResult', 'QR ì½”ë“œ ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }

  function decodeQRFromImageData(imgData) {
    qrDebugLog('QR ì½”ë“œ ë””ì½”ë”© ì‹œë„...');
    const inputElement = document.getElementById('qrInput');
    
    try {
      const code = jsQR(imgData.data, imgData.width, imgData.height, {inversionAttempts: "dontInvert"});
      if (code) {
        qrDebugLog('âœ“ QR ì½”ë“œ ì¸ì‹ ì„±ê³µ: ' + code.data, 'success');
        inputElement.value = code.data;
        stopQRCamera();
        document.getElementById('qrSearchResult').innerHTML = '<div class="alert alert-info">âœ… QR ì½”ë“œ ì¸ì‹ ì„±ê³µ: <strong>' + code.data + '</strong></div>';
        qrDebugLog('ìë™ ê²€ìƒ‰ ì‹œì‘...');
        setTimeout(() => {
          searchQR();
        }, 500);
      } else {
        qrDebugLog('âœ— QR ì½”ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ', 'error');
        showError('qrSearchResult', 'QR ì½”ë“œë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>â€¢ QR ì½”ë“œë¥¼ ë…¹ìƒ‰ ì˜ì—­ì— ë§ì¶°ì£¼ì„¸ìš”<br>â€¢ ì¡°ëª…ì„ ë°ê²Œ í•´ì£¼ì„¸ìš”');
        inputElement.focus();
      }
    } catch (e) {
      qrDebugLog('âœ— QR ë””ì½”ë”© ì˜¤ë¥˜: ' + e.message, 'error');
      showError('qrSearchResult', 'QR ì½”ë“œ ë””ì½”ë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      inputElement.focus();
    }
  }

  function stopQRCamera() {
    qrDebugLog('ì¹´ë©”ë¼ ë„ê¸°');
    CameraModule.stop('qr', {
      videoElement: document.getElementById('qrVideoElement'),
      containerElement: document.getElementById('qrScannerContainer'),
      captureButtonElement: document.getElementById('qrCaptureBtn'),
      buttonTextElement: document.getElementById('qrBtnText')
    });
  }

  function showLoading(id) {
    document.getElementById(id).innerHTML = '<div class="loading"><div class="spinner"></div><div>ë¡œë”© ì¤‘...</div></div>';
  }

  function showError(id, msg) {
    document.getElementById(id).innerHTML = '<div class="alert alert-error">' + msg + '</div>';
  }

  function loadLatestRevision() {
    google.script.run
      .withSuccessHandler(function(result) {
        const revisionText = document.getElementById('revisionText');
        if (result.success) {
          revisionText.innerHTML = `Revision <strong>${result.revision}</strong> (last update <strong>${result.date}</strong>)`;
        } else {
          revisionText.textContent = 'Revision ì •ë³´ ì—†ìŒ';
          console.log('Revision ë¡œë“œ ì‹¤íŒ¨:', result.message);
        }
      })
      .withFailureHandler(function(error) {
        document.getElementById('revisionText').textContent = 'Revision ë¡œë“œ ì‹¤íŒ¨';
        console.log('Revision ë¡œë“œ ì˜¤ë¥˜:', error);
      })
      .getLatestRevision();
  }

  function showRevisionHistory() {
    hideAllScreens();
    const s = document.getElementById('revisionHistoryScreen');
    s.style.display = 'block';
    s.classList.add('active');
    loadRevisionHistory();
    navigateToScreen('revisionHistoryScreen');
  }

  function loadRevisionHistory() {
    showLoading('revisionHistoryContent');
    google.script.run
      .withSuccessHandler(displayRevisionHistory)
      .withFailureHandler(function(error) {
        showError('revisionHistoryContent', 'Revision History ë¡œë“œ ì˜¤ë¥˜: ' + error);
      })
      .getRevisionHistory();
  }

  function displayRevisionHistory(result) {
    const container = document.getElementById('revisionHistoryContent');
    
    if (!result.success) {
      showError('revisionHistoryContent', result.message);
      return;
    }

    if (result.revisions.length === 0) {
      container.innerHTML = '<div class="alert alert-info">Revision ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }

    let tableHTML = '<div style="overflow-x: auto;"><table class="revision-table"><thead><tr>';
    
    result.headers.forEach(header => {
      tableHTML += `<th>${header}</th>`;
    });
    tableHTML += '</tr></thead><tbody>';

    result.revisions.forEach(revision => {
      tableHTML += '<tr>';
      result.headers.forEach(header => {
        const value = revision[header] !== undefined && revision[header] !== null ? revision[header] : '-';
        tableHTML += `<td>${value}</td>`;
      });
      tableHTML += '</tr>';
    });

    tableHTML += '</tbody></table></div>';
    container.innerHTML = tableHTML;
  }

  function handleQRInputEnter(event) {
    if (event.key === 'Enter' || event.keyCode === 13) {
      event.preventDefault();
      searchQR();
    }
  }
  
</script>
