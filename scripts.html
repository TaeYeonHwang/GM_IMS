<script>
  let allItems = [];
  let stream = null;
  let qrStream = null;
  let orderQRStream = null;
  let orderItems = [];
  let currentOrderType = 'b2c';
  let isNavigating = false; // Browser history navigation support
  let allInventoryItems = [];  // ì „ì²´ 1500ê°œ ì €ì¥
  let inventorySearchText = '';
  let isSubmitting = false;  // âœ… ADD: Prevent double submission

  // inventory status cache
  let inventoryStatusCache = null;
  let inventoryStatusCacheTime = null;
  let inventorySearchTimeout = null; // âœ… ADD: Timer value for Debouncing
  const INVENTORY_STATUS_CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
  
  // latest order cache
  let latestOrderCache = null;
  let latestOrderCacheTime = null;
  const LATEST_ORDER_CACHE_DURATION = 5 * 60 * 1000; // 5ë¶„

  // Handle browser back button
  window.addEventListener('popstate', function(event) {
    if (event.state && event.state.screen) {
      isNavigating = true;
      const screenName = event.state.screen;
      
      // Hide all screens
      hideAllScreens();
      
      // Show the appropriate screen
      const screen = document.getElementById(screenName);
      if (screen) {
        screen.style.display = 'block';
        screen.classList.add('active');
      }
      
      // Stop cameras
      stopOrderQRCamera();
      
      // Special handling for certain screens
      if (screenName === 'listScreen') {
        loadAllItems();
      } else if (screenName === 'guideScreen') {
        loadGuideImage();
      } else if (screenName === 'orderMainScreen') {
        // Reload order main screen data
        const today = new Date();
        const year = today.getFullYear();
        const month = today.getMonth() + 1;
        const day = today.getDate();
        const orderDate = year.toString() + month.toString().padStart(2, '0') + day.toString().padStart(2, '0');
        
        document.getElementById('todayDateText').textContent = `${year}ë…„ ${month}ì›” ${day}ì¼`;
        document.getElementById('searchOrderYear').value = year;
        document.getElementById('searchOrderMonth').value = month;
        document.getElementById('searchOrderDay').value = day;
        
        google.script.run
          .withSuccessHandler(function(result) {
            if (result.success) {
              document.getElementById('todayOrderCount').textContent = result.existingOrders || 0;
              if (result.orderIndex > 1) {
                document.getElementById('searchOrderIndex').value = result.orderIndex - 1;
              } else {
                document.getElementById('searchOrderIndex').value = '';
              }
            }
          })
          .getNewOrderIndex(orderDate);
      } else if (screenName === 'orderFormScreen') {
        // Keep current order form state
      } else if (screenName === 'qrSearchScreen') {
        const inputElement = document.getElementById('qrInput');
        setTimeout(() => {
          inputElement.focus();
        }, 100);
      }
      
      isNavigating = false;
    }
  });

  // Helper function to navigate with history
  function navigateToScreen(screenId) {
    if (!isNavigating) {
      history.pushState({ screen: screenId }, '', '#' + screenId);
    }
  }

  function debugLog(m, t) {
    const b = document.getElementById('debugBox');
    const l = document.getElementById('debugLogs');
    b.style.display = 'block';
    const c = t === 'error' ? 'debug-error' : (t === 'success' ? 'debug-success' : '');
    const e = document.createElement('div');
    e.className = 'debug-log ' + c;
    e.textContent = `[${new Date().toLocaleTimeString()}] ${m}`;
    l.appendChild(e);
    l.scrollTop = l.scrollHeight;
    console.log(m);
  }

  function clearDebugLog() {
    document.getElementById('debugLogs').innerHTML = '';
    document.getElementById('debugBox').style.display = 'none';
  }

  function qrDebugLog(m, t) {
    const b = document.getElementById('qrDebugBox');
    const l = document.getElementById('qrDebugLogs');
    b.style.display = 'block';
    const c = t === 'error' ? 'debug-error' : (t === 'success' ? 'debug-success' : '');
    const e = document.createElement('div');
    e.className = 'debug-log ' + c;
    e.textContent = `[${new Date().toLocaleTimeString()}] ${m}`;
    l.appendChild(e);
    l.scrollTop = l.scrollHeight;
    console.log(m);
  }

  function clearQRDebugLog() {
    document.getElementById('qrDebugLogs').innerHTML = '';
    document.getElementById('qrDebugBox').style.display = 'none';
  }

  function orderDebugLog(m, t) {
    const b = document.getElementById('orderDebugBox');
    const l = document.getElementById('orderDebugLogs');
    b.style.display = 'block';
    const c = t === 'error' ? 'debug-error' : (t === 'success' ? 'debug-success' : '');
    const e = document.createElement('div');
    e.className = 'debug-log ' + c;
    e.textContent = '[' + new Date().toLocaleTimeString() + '] ' + m;
    l.appendChild(e);
    l.scrollTop = l.scrollHeight;
    console.log(m);
  }

  function clearOrderDebugLog() {
    document.getElementById('orderDebugLogs').innerHTML = '';
    document.getElementById('orderDebugBox').style.display = 'none';
  }

  function hideAllScreens() {
    ['mainScreen', 'inventoryMenuScreen', 'listScreen', 'guideScreen', 'revisionHistoryScreen', 'orderMainScreen', 'orderFormScreen', 'orderViewScreen', 'memoScreen', 'customerScreen'].forEach(id => {
      document.getElementById(id).style.display = 'none';
      document.getElementById(id).classList.remove('active');
    });

  }

  function showMain() {
    hideAllScreens();
    const s = document.getElementById('mainScreen');
    s.style.display = 'block';
    s.classList.add('active');
    stopOrderQRCamera();
    loadDashboardInfo(); // Reload dashboard info when returning to main
    navigateToScreen('mainScreen');
  }

  function showInventoryMenu() {
    hideAllScreens();
    const s = document.getElementById('inventoryMenuScreen');
    s.style.display = 'block';
    s.classList.add('active');
    stopOrderQRCamera();

    // âœ… NEW: Check local cache first
    const now = Date.now();
    if (inventoryStatusCache && inventoryStatusCacheTime && 
        (now - inventoryStatusCacheTime < INVENTORY_STATUS_CACHE_DURATION)) {
      // Cache HIT - display immediately
      console.log('Frontend cache HIT: inventory_status');
      updateInventoryStatusUI(inventoryStatusCache);
    } else {
      // Cache MISS - show loading and fetch from server
      console.log('Frontend cache MISS: inventory_status');
      document.getElementById('inventoryOutCount').textContent = '-';
      document.getElementById('inventoryLowCount').textContent = '-';
      document.getElementById('inventoryNormalCount').textContent = '-';
      
      loadInventoryStatus();
    }

    navigateToScreen('inventoryMenuScreen');
  }

  // ===== Load inventory status for menu screen =====
  function loadInventoryStatus() {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          // âœ… NEW: Save to frontend cache
          inventoryStatusCache = result;
          inventoryStatusCacheTime = Date.now();
          console.log('Frontend cache SET: inventory_status');
          // Update UI
          updateInventoryStatusUI(result);
        } else {
          console.error('Failed to load inventory status:', result.message);
          // Show error counts
          document.getElementById('inventoryOutCount').textContent = '?';
          document.getElementById('inventoryLowCount').textContent = '?';
          document.getElementById('inventoryNormalCount').textContent = '?';
        }
      })
      .withFailureHandler(function(error) {
        console.error('Error loading inventory status:', error);
        // Show error counts
        document.getElementById('inventoryOutCount').textContent = '?';
        document.getElementById('inventoryLowCount').textContent = '?';
        document.getElementById('inventoryNormalCount').textContent = '?';
      })
      .getInventoryStatusCountsFromSheet();
  }

  // âœ… NEW: Update inventory status UI
  function updateInventoryStatusUI(result) {
    document.getElementById('inventoryOutCount').textContent = result.outCount + 'ê°œ';
    document.getElementById('inventoryLowCount').textContent = result.lowCount + 'ê°œ';
    document.getElementById('inventoryNormalCount').textContent = result.normalCount + 'ê°œ';
  }

  function showOrderMenu() {
    hideAllScreens();
    const s = document.getElementById('orderMenuScreen');
    s.style.display = 'block';
    s.classList.add('active');
    stopOrderQRCamera();
  }

  function showOrderMain() {
    hideAllScreens();
    const s = document.getElementById('orderMainScreen');
    s.style.display = 'block';
    s.classList.add('active');
    stopOrderQRCamera();
    
    // ë””ë²„ê·¸ ë¡œê·¸ ì´ˆê¸°í™”
    clearOrderDebugLog();
    orderDebugLog('ì£¼ë¬¸ì„œ ë©”ì¸ í™”ë©´ ë¡œë“œ ì‹œì‘');

    // ì˜¤ëŠ˜ ë‚ ì§œ í‘œì‹œ
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth() + 1;
    const day = today.getDate();      
    orderDebugLog('ì˜¤ëŠ˜ ë‚ ì§œ: ' + year + 'ë…„ ' + month + 'ì›” ' + day + 'ì¼');

    document.getElementById('todayDateText').textContent = `${year}ë…„ ${month}ì›” ${day}ì¼`;
    
    // Set Today as a default date in Search input field.
    document.getElementById('searchOrderYear').value = year;
    document.getElementById('searchOrderMonth').value = month;
    document.getElementById('searchOrderDay').value = day;
    
    // Update tab info
    updateTabInfo();

    // Load latest order card
    loadLatestOrderCard();

    // ì˜¤ëŠ˜ ìƒì„±ëœ ì£¼ë¬¸ì„œ ìˆ˜ ì¡°íšŒ
    const orderDate = year.toString() + month.toString().padStart(2, '0') + day.toString().padStart(2, '0');
    orderDebugLog('ì£¼ë¬¸ ë‚ ì§œ ë¬¸ìì—´: ' + orderDate);
    orderDebugLog('ì„œë²„ì— ì˜¤ëŠ˜ ì£¼ë¬¸ ìˆ˜ ìš”ì²­ ì¤‘...');

    google.script.run
      .withSuccessHandler(function(result) {
        orderDebugLog('ì„œë²„ ì‘ë‹µ ë°›ìŒ', 'success');
    
        if (result.success) {
          orderDebugLog('ì˜¤ëŠ˜ ì£¼ë¬¸ì„œ ê°œìˆ˜: ' + result.orderCount, 'success');
          document.getElementById('todayOrderCount').textContent = result.orderCount;
        } else {
          orderDebugLog('ì„œë²„ ì‘ë‹µ ì‹¤íŒ¨: ' + result.message, 'error');
          document.getElementById('todayOrderCount').textContent = '0';
        }
      })
      .withFailureHandler(function(error) {
        orderDebugLog('ì„œë²„ ìš”ì²­ ì‹¤íŒ¨: ' + error, 'error');
        document.getElementById('todayOrderCount').textContent = '?';
      })
      .getTodayOrderCount();

      navigateToScreen('orderMainScreen');
  }

  // ===== Load Latest Order Card =====
  function loadLatestOrderCard() {
    const container = document.getElementById('latestOrderCard');

    // âœ… Frontend ìºì‹œ í™•ì¸
    const now = Date.now();
    if (latestOrderCache && latestOrderCacheTime && 
        (now - latestOrderCacheTime < LATEST_ORDER_CACHE_DURATION)) {
      console.log('âœ“ Frontend cache HIT: latest_order');
      displayLatestOrderCard(latestOrderCache);
      return;
    }
    console.log('âœ— Frontend cache MISS: latest_order');
    container.innerHTML = '<div class="loading"><div class="spinner"></div><div>ì§ì „ ì£¼ë¬¸ì„œ ë¡œë”© ì¤‘...</div></div>';
    
    console.log('ğŸ“‹ ì§ì „ ì£¼ë¬¸ì„œ ìš”ì²­ ì‹œì‘');  // âœ… ì¶”ê°€

    google.script.run
      .withSuccessHandler(function(result) {
        // âœ… Frontend ìºì‹œ ì €ì¥
        latestOrderCache = result;
        latestOrderCacheTime = Date.now();

        if (result.success && result.hasOrder) {
          displayLatestOrderCard(result);
        } else if (result.success && !result.hasOrder) {
          // No orders today
          container.innerHTML = `
            <div class="latest-order-empty">
              ğŸ“­ ${result.message}
            </div>
          `;
        } else {
          container.innerHTML = `
            <div class="alert alert-error">
              ${result.message}
            </div>
          `;
        }
      })
      .withFailureHandler(function(error) {

        console.log('ğŸ“‹ ì§ì „ ì£¼ë¬¸ì„œ ì—ëŸ¬:', error);  // âœ… ì¶”ê°€

        container.innerHTML = `
          <div class="alert alert-error">
            ì§ì „ ì£¼ë¬¸ì„œ ë¡œë“œ ì¤‘ ì˜¤ë¥˜: ${error}
          </div>
        `;
      })
      .getLatestTodayOrder();
  }

  // ===== Display Latest Order Card =====
  function displayLatestOrderCard(data) {
    const container = document.getElementById('latestOrderCard');
  
    const isCanceled = data.isCanceled === true;
    const cardBorder = isCanceled ? 'border: 2px solid #fee2e2; border-left: 5px solid #dc2626;' : 'border: 2px solid #e8ecef; border-left: 5px solid #27ae60;';
    const titleColor = isCanceled ? '#dc2626' : '#27ae60';
    const accentColor = isCanceled ? '#dc2626' : '#27ae60';
    
    let html = '<div style="background: white; ' + cardBorder + ' padding: 25px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);">';
    
    // Header
    html += '<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">';
    html += '<div>';
    html += '<div style="color: ' + accentColor + '; font-size: 16px; font-weight: 600; margin-bottom: 8px;">âœ¨ ì§ì „ ìµœì‹  ì£¼ë¬¸ì„œ</div>';
    html += '<h3 style="font-size: 28px; color: ' + titleColor + '; margin: 0 0 8px 0; font-weight: 700;">';
    html += data.orderSerialNumber;
    html += '</h3>';
    html += '</div>';
    
    // Buttons
    html += '<div style="display: flex; gap: 8px;">';
    if (isCanceled) {
      html += '<div style="background: #fee2e2; color: #dc2626; padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 16px; white-space: nowrap; height: fit-content;">âŒ ì·¨ì†Œë¨</div>';
    } else {
      html += '<button class="btn btn-secondary btn-small" onclick="generateReceiptFromLatest(\'' + data.orderSerialNumber + '\')" style="margin: 0; white-space: nowrap; height: fit-content;">ğŸ“„ ì˜ìˆ˜ì¦</button>';
      html += '<button class="btn btn-secondary btn-small" onclick="confirmCancelOrderFromList(\'' + data.orderSerialNumber + '\')" style="margin: 0; white-space: nowrap; height: fit-content;">âŒ ì·¨ì†Œ</button>';
    }
    html += '</div>';
    html += '</div>';
    
    // Info
    html += '<div style="color: #7f8c8d; font-size: 18px; line-height: 1.8; margin-bottom: 20px;">';
    html += 'ì£¼ë¬¸ ì‹œê°„: <strong style="color: #2c3e50;">' + data.orderTime + '</strong><br>';
    html += 'ì£¼ë¬¸ ê¸ˆì•¡: <strong style="color: ' + accentColor + ';">' + data.totalAmount.toLocaleString() + 'ì›</strong> (' + data.payType + ')';
    html += '</div>';
    
    // âœ… ì „ì²´ í’ˆëª© í…Œì´ë¸” í‘œì‹œ
    html += '<div style="overflow-x: auto;">';
    html += '<table class="order-table">';
    html += '<thead>';
    html += '<tr style="border-bottom: none;">';
    html += '<th rowspan="2" style="vertical-align: middle; width: 15%;">ì½”ë“œë²ˆí˜¸</th>';
    html += '<th style="padding-bottom: 8px; width: 35%;">í’ˆëª…</th>';
    html += '<th style="padding-bottom: 8px; width: 20%;">íƒ€ì…</th>';
    html += '<th style="padding-bottom: 8px; width: 15%;">ê°œìˆ˜</th>';
    html += '</tr>';
    html += '<tr>';
    html += '<th style="padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">ì„¤ëª…</th>';
    html += '<th style="padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">ê°€ê²©</th>';
    html += '<th style="padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">ì´ê°€ê²©</th>';
    html += '</tr>';
    html += '</thead>';
    html += '<tbody>';
    
    data.items.forEach(function(item) {
      const cost = item.isB2B === 1 ? item.costB2B : item.costB2C;
      const textStyle = isCanceled ? 'text-decoration: line-through; opacity: 0.5;' : '';
      
      // First row
      html += '<tr style="border-bottom: none;">';
      html += '<td rowspan="2" style="vertical-align: middle; font-weight: 600; font-size: 18px; ' + textStyle + '">' + item.codeNum + '</td>';
      html += '<td style="font-size: 18px; font-weight: 600; text-align: left; padding: 15px 15px 5px 15px; ' + textStyle + '">' + item.name + '</td>';
      html += '<td style="padding: 15px 10px 5px 10px; text-align: center; ' + textStyle + '">' + (item.isB2B === 1 ? 'ë„' : 'ì†Œ') + '</td>';
      html += '<td style="vertical-align: middle; font-size: 18px; text-align: center; padding: 15px 10px 5px 10px; ' + textStyle + '">' + item.cnt + '</td>';
      html += '</tr>';
      
      // Second row
      html += '<tr style="border-bottom: 2px solid #ddd;">';
      html += '<td style="text-align: left; padding: 5px 15px 15px 15px; font-size: 16px; color: #666; ' + textStyle + '">' + (item.description || '-') + '</td>';
      html += '<td style="padding: 5px 15px 15px 15px; text-align: center; ' + textStyle + '"><strong style="color: ' + accentColor + '; font-size: 18px;">' + cost.toLocaleString() + 'ì›</strong></td>';
      html += '<td style="padding: 5px 15px 15px 15px; text-align: center; ' + textStyle + '"><strong style="color: ' + accentColor + '; font-size: 18px;">' + (cost * item.cnt).toLocaleString() + 'ì›</strong></td>';
      html += '</tr>';
    });
    
    html += '</tbody>';
    html += '</table>';
    html += '</div>';
    
    html += '</div>';
    
    container.innerHTML = html;
  }

  // ===== View Latest Order =====
  function viewLatestOrder(orderSerialNumber) {
    const dateStr = orderSerialNumber.substring(0, 8);
    const indexStr = parseInt(orderSerialNumber.substring(8));
    
    showLoadingMessage('ì£¼ë¬¸ì„œ ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
    
    google.script.run
      .withSuccessHandler(function(result) {
        hideLoadingMessage();
        if (result.success) {
          hideAllScreens();
          const s = document.getElementById('orderViewScreen');
          s.style.display = 'block';
          s.classList.add('active');
          displayOrderView(result.orders);
          navigateToScreen('orderViewScreen');
        } else {
          alert(result.message);
        }
      })
      .withFailureHandler(function(error) {
        hideLoadingMessage();
        alert('ì£¼ë¬¸ì„œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜: ' + error);
      })
      .getOrderData(dateStr, indexStr);
  }

  // ===== Generate Receipt from Latest =====
  function generateReceiptFromLatest(orderSerialNumber) {
    showLoadingMessage('ì˜ìˆ˜ì¦ì„ ìƒì„±í•˜ëŠ” ì¤‘...');
    
    google.script.run
      .withSuccessHandler(function(result) {
        hideLoadingMessage();
        
        if (result.success) {
          alert(`ì˜ìˆ˜ì¦ ${result.count}ê°œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`);
          
          if (result.files.length > 0) {
            window.open(result.files[0].url, '_blank');
          }
        } else {
          alert('ì˜ìˆ˜ì¦ ìƒì„± ì‹¤íŒ¨: ' + result.message);
        }
      })
      .withFailureHandler(function(error) {
        hideLoadingMessage();
        alert('ì˜ìˆ˜ì¦ ìƒì„± ì¤‘ ì˜¤ë¥˜: ' + error);
      })
      .generateReceiptPDF(orderSerialNumber);
  }


  function showNewOrderForm() {
    hideAllScreens();
    const s = document.getElementById('orderFormScreen');
    s.style.display = 'block';
    s.classList.add('active');
    
    // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¤ì •
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth() + 1;
    const day = today.getDate();
    
    const orderDate = year.toString() + month.toString().padStart(2, '0') + day.toString().padStart(2, '0');
    
    // ë‚ ì§œ í…ìŠ¤íŠ¸ í‘œì‹œ
    document.getElementById('newOrderDateText').textContent = `${year}ë…„ ${month}ì›” ${day}ì¼`;
    
    // ì‹ ê·œ ì£¼ë¬¸ì„œ ë²ˆí˜¸ ê°€ì ¸ì˜¤ê¸°
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          document.getElementById('newOrderIndexText').textContent = result.orderIndex;
          // ë‚´ë¶€ì ìœ¼ë¡œ ì‚¬ìš©í•  ê°’ ì €ì¥
          window.currentOrderDate = orderDate;
          window.currentOrderIndex = result.orderIndex;
        }
      })
      .getNewOrderIndex(orderDate);
    
    // ì´ˆê¸°í™”
    orderItems = [];
    document.getElementById('orderItemsBody').innerHTML = '';
    document.getElementById('orderSearchInput').value = '';
    document.getElementById('orderMessage').innerHTML = '';
    currentOrderType = 'b2c';
    document.querySelector('input[name="orderType"][value="b2c"]').checked = true;

    // Focus on search input after a short delay
    setTimeout(() => {
      document.getElementById('orderSearchInput').focus();
    }, 100);

    navigateToScreen('orderFormScreen');
  }

  function handleOrderSearchEnter(event) {
    if (event.key === 'Enter' || event.keyCode === 13) {
      event.preventDefault();
      searchItemForOrder();
    }
  }

  function displayOrderView(orders) {
    const orderSerialNumber = orders[0].serialNumber;
    const orderDateStr = orders[0].date.toString();
    const year = orderDateStr.substring(0, 4);
    const month = orderDateStr.substring(4, 6);
    const day = orderDateStr.substring(6, 8);
    const formattedDate = year + 'ë…„ ' + parseInt(month) + 'ì›” ' + parseInt(day) + 'ì¼';

    const orderTime = orders[0].time || '-';
    const payType = orders[0].payType || '-';
    const isCanceled = orders[0].isCanceled === true;

    let totalAmount = 0;
    let totalQty = 0;
    orders.forEach(function(order) {
      totalAmount += order.totalCost || 0;
      totalQty += order.cnt || 0;
    });

    const cardBorder = isCanceled ? 'border: 2px solid #fee2e2; border-left: 5px solid #dc2626;' : 'border: 2px solid #e8ecef; border-left: 5px solid #3498db;';
    const titleColor = isCanceled ? '#dc2626' : '#2c3e50';
    const accentColor = isCanceled ? '#dc2626' : '#3498db';

    let html = '<div style="background: white; ' + cardBorder + ' padding: 25px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);">';
    
    // Header
    html += '<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">';
    html += '<div>';
    html += '<h3 style="font-size: 28px; color: ' + titleColor + '; margin: 0 0 8px 0; font-weight: 700;">';
    html += orderSerialNumber;
    html += '</h3>';
    html += '</div>';
    
    // Cancel badge or button
    html += '<div style="display: flex; gap: 8px;">';
    if (isCanceled) {
      html += '<div style="background: #fee2e2; color: #dc2626; padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 16px; white-space: nowrap; height: fit-content;">âŒ ì·¨ì†Œë¨</div>';
    } else {
      html += '<button class="btn btn-secondary btn-small" onclick="confirmCancelOrder(\'' + orderSerialNumber + '\')" style="margin: 0; white-space: nowrap; height: fit-content;">âŒ ì·¨ì†Œ</button>';
    }
    html += '</div>';
    html += '</div>';
    
    // Info
    html += '<div style="color: #7f8c8d; font-size: 18px; line-height: 1.8; margin-bottom: 20px;">';
    html += 'ì£¼ë¬¸ ì‹œê°„: <strong style="color: #2c3e50;">' + orderTime + '</strong><br>';
    html += 'ì£¼ë¬¸ ê¸ˆì•¡: <strong style="color: ' + accentColor + ';">' + totalAmount.toLocaleString() + 'ì›</strong> (' + payType + ')';
    html += '</div>';

    // Items section
    html += '<div style="background: white; padding: 30px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04); border: 2px solid #e8ecef;">';
    html += '<h3 style="font-size: 24px; color: #2c3e50; margin-bottom: 20px; font-weight: 600;">ì£¼ë¬¸ í’ˆëª© ëª©ë¡</h3>';
    html += '<div style="overflow-x: auto;">';
    html += '<table class="order-table" id="orderViewTable">';
    html += '<thead>';
    html += '<tr style="border-bottom: none;">';
    html += '<th rowspan="2" style="vertical-align: middle; width: 20%;">ì½”ë“œë²ˆí˜¸</th>';
    html += '<th style="padding-bottom: 8px; width: 40%;">í’ˆëª…</th>';
    html += '<th style="padding-bottom: 8px; width: 20%;">íƒ€ì…</th>';
    html += '<th style="padding-bottom: 8px; width: 20%;">ê°œìˆ˜</th>';
    html += '</tr>';
    html += '<tr>';
    html += '<th style="padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">ì„¤ëª…</th>';
    html += '<th style="padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">ê°€ê²©</th>';
    html += '<th style="padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">ì´ê°€ê²©</th>';
    html += '</tr>';
    html += '</thead>';
    html += '<tbody id="orderViewBody"></tbody>';
    html += '</table>';
    html += '</div>';
    html += '</div>';

    // Summary section
    const summaryBorderColor = isCanceled ? '#fee2e2' : '#e3f2fd';
    html += '<div style="background: white; padding: 30px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04); border: 2px solid ' + summaryBorderColor + ';">';
    html += '<h3 style="font-size: 24px; color: #2c3e50; margin-bottom: 20px; font-weight: 600;">ì£¼ë¬¸ ìš”ì•½</h3>';
    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">';
    
    html += '<div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">';
    html += '<div style="color: #7f8c8d; font-size: 16px; margin-bottom: 8px;">ì´ ì£¼ë¬¸ ê¸ˆì•¡</div>';
    html += '<div style="color: #3498db; font-size: 32px; font-weight: 700;">' + totalAmount.toLocaleString() + 'ì›</div>';
    html += '</div>';
    
    html += '<div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">';
    html += '<div style="color: #7f8c8d; font-size: 16px; margin-bottom: 8px;">ì´ í’ˆëª© ìˆ˜</div>';
    html += '<div style="color: #2c3e50; font-size: 32px; font-weight: 700;">' + orders.length + 'ê°œ</div>';
    html += '</div>';
    
    html += '<div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">';
    html += '<div style="color: #7f8c8d; font-size: 16px; margin-bottom: 8px;">ì´ ìˆ˜ëŸ‰</div>';
    html += '<div style="color: #2c3e50; font-size: 32px; font-weight: 700;">' + totalQty + 'ê°œ</div>';
    html += '</div>';
    
    html += '</div>';
    html += '</div>';

    // Cancel button
    if (!isCanceled) {
      html += '<button class="btn btn-secondary" onclick="confirmCancelOrder(\'' + orderSerialNumber + '\')" style="margin-top: 0;">';
      html += '<span>âŒ</span> ì£¼ë¬¸ ì·¨ì†Œí•˜ê¸°';
      html += '</button>';
    }

    document.getElementById('orderViewContent').innerHTML = html;

    const tbody = document.getElementById('orderViewBody');
    orders.forEach(function(order) {
      const cost = order.isB2B === 1 ? order.costB2B : order.costB2C;

      // First row
      const row1 = tbody.insertRow();
      row1.style.borderBottom = 'none';
      row1.innerHTML = '<td rowspan="2" style="vertical-align: middle; font-weight: 600; font-size: 20px;">' + 
        order.codeNum + 
        '</td>' +
        '<td style="font-size: 20px; font-weight: 600; text-align: left; padding: 15px 15px 5px 15px;">' + 
        order.name + 
        '</td>' +
        '<td style="padding: 15px 10px 5px 10px; text-align: center;">' + 
        (order.isB2B === 1 ? 'ë„' : 'ì†Œ') + 
        '</td>' +
        '<td style="vertical-align: middle; font-size: 20px; text-align: center; padding: 15px 10px 5px 10px;">' + 
        order.cnt + 
        '</td>';
      
      // Second row
      const row2 = tbody.insertRow();
      row2.style.borderBottom = '2px solid #ddd';
      row2.innerHTML = '<td style="text-align: left; padding: 5px 15px 15px 15px; font-size: 18px; color: #666;">' + 
        (order.description || '-') + 
        '</td>' +
        '<td style="padding: 5px 15px 15px 15px; text-align: center;">' +
        '<strong style="color: #3498db; font-size: 20px;">' + cost.toLocaleString() + 'ì›</strong>' +
        '</td>' +
        '<td style="padding: 5px 15px 15px 15px; text-align: center;">' +
        '<strong style="color: #3498db; font-size: 20px;">' + order.totalCost.toLocaleString() + 'ì›</strong>' +
        '</td>';
    });
  }

  // ===== NEW FUNCTION: Cancel Order =====
  function confirmCancelOrder(orderSerialNumber) {
    if (confirm('ì •ë§ë¡œ ì´ ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì£¼ë¬¸ë²ˆí˜¸: ' + orderSerialNumber + '\n\nì¬ê³ ê°€ ë³µì›ë©ë‹ˆë‹¤.')) {
      cancelOrderById(orderSerialNumber);
    }
  }

  function cancelOrderById(orderSerialNumber) {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {

          // Invalidate latest order cache
          latestOrderCache = null;
          latestOrderCacheTime = null;

          alert('ì£¼ë¬¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì·¨ì†Œëœ í’ˆëª© ìˆ˜: ' + result.canceledRows + 'ê°œ\nì¬ê³ ê°€ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.');
          
          // Reload the order view to show updated status
          const dateStr = orderSerialNumber.substring(0, 8);
          const indexStr = parseInt(orderSerialNumber.substring(8));
          
          google.script.run
            .withSuccessHandler(function(result) {
              if (result.success) {
                displayOrderView(result.orders);
              }
            })
            .getOrderData(dateStr, indexStr);
        } else {
          alert('ì£¼ë¬¸ ì·¨ì†Œ ì‹¤íŒ¨:\n' + result.message);
        }
      })
      .withFailureHandler(function(error) {
        alert('ì£¼ë¬¸ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:\n' + error);
      })
      .cancelOrder(orderSerialNumber);
  }

  function displayOrderList(orderDate, orderList) {
    const dateStr = orderDate.toString();
    const year = dateStr.substring(0, 4);
    const month = dateStr.substring(4, 6);
    const day = dateStr.substring(6, 8);
    const formattedDate = `${year}ë…„ ${parseInt(month)}ì›” ${parseInt(day)}ì¼`;
    
    // âœ… ëª¨ë“  ì£¼ë¬¸ì„œ ë°ì´í„° í•œë²ˆì— ê°€ì ¸ì˜¤ê¸°
    let loadedCount = 0;
    const allOrders = [];
    
    orderList.forEach(index => {
      google.script.run
        .withSuccessHandler(function(result) {
          loadedCount++;
          
          if (result.success) {
            allOrders.push({
              index: index,
              orders: result.orders
            });
          }
          
          // ëª¨ë“  ì£¼ë¬¸ì„œ ë¡œë“œ ì™„ë£Œ
          if (loadedCount === orderList.length) {
            // ì¸ë±ìŠ¤ ìˆœì„œëŒ€ë¡œ ì •ë ¬
            allOrders.sort((a, b) => a.index - b.index);
            displayAllOrders(orderDate, formattedDate, allOrders);
          }
        })
        .withFailureHandler(function(error) {
          loadedCount++;
          console.error(`ì£¼ë¬¸ì„œ #${index} ì¡°íšŒ ì‹¤íŒ¨:`, error);
        })
        .getOrderData(orderDate, index);
    });
  }

  function displayAllOrders(orderDate, formattedDate, allOrders) {
    let totalAmount = 0;
    let totalItems = 0;
    let totalQty = 0;
    
    // Calculate totals
    allOrders.forEach(function(orderGroup) {
      orderGroup.orders.forEach(function(order) {
        totalAmount += order.totalCost || 0;
        totalQty += order.cnt || 0;
      });
      totalItems += orderGroup.orders.length;
    });
    
    // Header
    let html = '<div style="background: white; padding: 30px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04); border: 2px solid #e8ecef; border-left: 5px solid #3498db;">';
    html += '<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">';
    html += '<span style="font-size: 42px;">ğŸ“‹</span>';
    html += '<div>';
    html += '<h2 style="font-size: 38px; color: #2c3e50; margin: 0; font-weight: 700;">ì „ì²´ ì£¼ë¬¸ì„œ ëª©ë¡</h2>';
    html += '<div style="color: #7f8c8d; font-size: 18px; margin-top: 8px;">ğŸ“… ' + formattedDate + ' Â· ì´ <strong style="color: #3498db;">' + allOrders.length + '</strong>ê°œ ì£¼ë¬¸ì„œ</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // Display each order
    allOrders.forEach(function(orderGroup) {
      const orderSerialNumber = orderGroup.orders[0].serialNumber;
      const orderTime = orderGroup.orders[0].time || '-';
      const payType = orderGroup.orders[0].payType || '-';
      const isCanceled = orderGroup.orders[0].isCanceled === true;
      let orderAmount = 0;
      let orderQty = 0;
      
      orderGroup.orders.forEach(function(order) {
        orderAmount += order.totalCost || 0;
        orderQty += order.cnt || 0;
      });

      // âœ… NEW: Modern card style
      const cardBorder = isCanceled ? 'border: 2px solid #fee2e2; border-left: 5px solid #dc2626;' : 'border: 2px solid #e8ecef; border-left: 5px solid #3498db;';
      const titleColor = isCanceled ? '#dc2626' : '#2c3e50';
      const accentColor = isCanceled ? '#dc2626' : '#3498db';

      html += '<div style="background: white; ' + cardBorder + ' padding: 25px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);">';
      
      // Header with cancel badge or button
      html += '<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">';
      html += '<div>';
      html += '<h3 style="font-size: 28px; color: ' + titleColor + '; margin: 0 0 8px 0; font-weight: 700;">';
      html += orderSerialNumber;  // âœ… 202511030001
      html += '</h3>';
      html += '</div>';
      
      if (isCanceled) {
        html += '<div style="background: #fee2e2; color: #dc2626; padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 16px; white-space: nowrap; height: fit-content;">âŒ ì·¨ì†Œë¨</div>';
      } else {
        html += '<button class="btn btn-secondary btn-small" onclick="generateReceiptFromList(\'' + orderSerialNumber + '\')" style="margin: 0; white-space: nowrap; height: fit-content;">ğŸ“„ ì˜ìˆ˜ì¦</button>';
        html += '<button class="btn btn-secondary btn-small" onclick="confirmCancelOrderFromList(\'' + orderSerialNumber + '\', \'' + orderDate + '\')" style="margin: 0; white-space: nowrap; height: fit-content;">âŒ ì·¨ì†Œ</button>';
      }
      html += '</div>';
      
      // âœ… NEW: Simple text info (removed card-style grid)
      html += '<div style="color: #7f8c8d; font-size: 18px; line-height: 1.8; margin-bottom: 20px;">';
      html += 'ì£¼ë¬¸ ì‹œê°„: <strong style="color: #2c3e50;">' + orderTime + '</strong><br>';
      html += 'ì£¼ë¬¸ ê¸ˆì•¡: <strong style="color: ' + accentColor + ';">' + orderAmount.toLocaleString() + 'ì›</strong> (' + payType + ')';
      html += '</div>';
      
      html += '<div style="overflow-x: auto;">';
      html += '<table class="order-table">';
      html += '<thead>';
      html += '<tr style="border-bottom: none;">';
      html += '<th rowspan="2" style="vertical-align: middle; width: 15%;">ì½”ë“œë²ˆí˜¸</th>';
      html += '<th style="padding-bottom: 8px; width: 35%;">í’ˆëª…</th>';
      html += '<th style="padding-bottom: 8px; width: 20%;">íƒ€ì…</th>';
      html += '<th style="padding-bottom: 8px; width: 15%;">ê°œìˆ˜</th>';
      html += '</tr>';
      html += '<tr>';
      html += '<th style="padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">ì„¤ëª…</th>';
      html += '<th style="padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">ê°€ê²©</th>';
      html += '<th style="padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">ì´ê°€ê²©</th>';
      html += '</tr>';
      html += '</thead>';
      html += '<tbody>';
      
      orderGroup.orders.forEach(function(order) {
        const cost = order.isB2B === 1 ? order.costB2B : order.costB2C;
        const textStyle = isCanceled ? 'text-decoration: line-through; opacity: 0.5;' : '';
      
        // First row
        html += '<tr style="border-bottom: none;">';
        html += '<td rowspan="2" style="vertical-align: middle; font-weight: 600; font-size: 18px; ' + textStyle + '">';
        html += order.codeNum;
        html += '</td>';
        html += '<td style="font-size: 18px; font-weight: 600; text-align: left; padding: 15px 15px 5px 15px; ' + textStyle + '">';
        html += order.name;
        html += '</td>';
        html += '<td style="padding: 15px 10px 5px 10px; text-align: center; ' + textStyle + '">';
        html += order.isB2B === 1 ? 'ë„' : 'ì†Œ';
        html += '</td>';
        html += '<td style="vertical-align: middle; font-size: 18px; text-align: center; padding: 15px 10px 5px 10px; ' + textStyle + '">';
        html += order.cnt;
        html += '</td>';
        html += '</tr>';
        
        // Second row
        html += '<tr style="border-bottom: 2px solid #ddd;">';
        html += '<td style="text-align: left; padding: 5px 15px 15px 15px; font-size: 16px; color: #666; ' + textStyle + '">';
        html += order.description || '-';
        html += '</td>';
        html += '<td style="padding: 5px 15px 15px 15px; text-align: center; ' + textStyle + '">';
        html += '<strong style="color: ' + accentColor + '; font-size: 18px;">' + cost.toLocaleString() + 'ì›</strong>';
        html += '</td>';
        html += '<td style="padding: 5px 15px 15px 15px; text-align: center; ' + textStyle + '">';
        html += '<strong style="color: ' + accentColor + '; font-size: 18px;">' + order.totalCost.toLocaleString() + 'ì›</strong>';
        html += '</td>';
        html += '</tr>';
      });
      
      html += '</tbody>';
      html += '</table>';
      html += '</div>';
      html += '</div>';
    });
    
    // Summary card
    html += '<div style="background: white; padding: 30px; border-radius: 16px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04); border: 2px solid #e3f2fd; border-left: 5px solid #3498db;">';
    html += '<h3 style="font-size: 24px; color: #2c3e50; margin-bottom: 20px; font-weight: 600;">ğŸ“Š ì „ì²´ í•©ê³„</h3>';
    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">';
    
    html += '<div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">';
    html += '<div style="color: #7f8c8d; font-size: 16px; margin-bottom: 8px;">ì´ ì£¼ë¬¸ ê¸ˆì•¡</div>';
    html += '<div style="color: #3498db; font-size: 32px; font-weight: 700;">' + totalAmount.toLocaleString() + 'ì›</div>';
    html += '</div>';
    
    html += '<div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">';
    html += '<div style="color: #7f8c8d; font-size: 16px; margin-bottom: 8px;">ì´ í’ˆëª© ìˆ˜</div>';
    html += '<div style="color: #2c3e50; font-size: 32px; font-weight: 700;">' + totalItems + 'ê°œ</div>';
    html += '</div>';
    
    html += '<div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">';
    html += '<div style="color: #7f8c8d; font-size: 16px; margin-bottom: 8px;">ì´ ìˆ˜ëŸ‰</div>';
    html += '<div style="color: #2c3e50; font-size: 32px; font-weight: 700;">' + totalQty + 'ê°œ</div>';
    html += '</div>';
    
    html += '</div>';
    html += '</div>';
    
    document.getElementById('orderViewContent').innerHTML = html;
  }

  // ===== NEW FUNCTION: Cancel order from list view =====
  function confirmCancelOrderFromList(orderSerialNumber, orderDate) {
    if (confirm('ì •ë§ë¡œ ì´ ì£¼ë¬¸ì„ ì·¨ì†Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì£¼ë¬¸ë²ˆí˜¸: ' + orderSerialNumber + '\n\nì¬ê³ ê°€ ë³µì›ë©ë‹ˆë‹¤.')) {
      cancelOrderAndRefreshList(orderSerialNumber, orderDate);
    }
  }

  function cancelOrderAndRefreshList(orderSerialNumber, orderDate) {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          // âœ… NEW: Invalidate frontend cache
          inventoryStatusCache = null;
          inventoryStatusCacheTime = null;
          console.log('Frontend cache INVALIDATED: inventory_status (order canceled)');

          alert('ì£¼ë¬¸ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.\n\nì·¨ì†Œëœ í’ˆëª© ìˆ˜: ' + result.canceledRows + 'ê°œ\nì¬ê³ ê°€ ë³µì›ë˜ì—ˆìŠµë‹ˆë‹¤.');
          
          // âœ… ì£¼ë¬¸ ê´€ë¦¬ ë©”ì¸ í™”ë©´ì´ë©´ ì¹´ë“œë§Œ ìƒˆë¡œê³ ì¹¨
          if (document.getElementById('orderMainScreen').classList.contains('active')) {
            loadLatestOrderCard();
          } else {
            // âœ… ëª©ë¡ í™”ë©´ì´ë©´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            google.script.run
              .withSuccessHandler(function(listResult) {
                if (listResult.success) {
                  hideAllScreens();
                  const s = document.getElementById('orderViewScreen');
                  s.style.display = 'block';
                  s.classList.add('active');
                  displayOrderList(orderDate, listResult.orderList);
                }
              })
              .getOrderListByDate(orderDate);
          }
        } else {
          alert('ì£¼ë¬¸ ì·¨ì†Œ ì‹¤íŒ¨:\n' + result.message);
        }
      })
      .withFailureHandler(function(error) {
        alert('ì£¼ë¬¸ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:\n' + error);
      })
      .cancelOrder(orderSerialNumber);
  }

  function updateOrderType() {
    const type = document.querySelector('input[name="orderType"]:checked').value;
    currentOrderType = type;
    renderOrderItems();
  }

  function searchItemForOrder() {
    const codeNum = document.getElementById('orderSearchInput').value.trim();
    
    if (!codeNum) {
      showOrderMessage('ì½”ë“œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
      return;
    }
    
    showOrderMessage('ê²€ìƒ‰ ì¤‘...', 'info');
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          addItemToOrder(result.item);
          document.getElementById('orderSearchInput').value = '';
          
          // Keep focus on search input
          setTimeout(() => {
            document.getElementById('orderSearchInput').focus();
          }, 100);
        } else {
          showOrderMessage(result.message, 'error');

          // Keep focus on search input
          setTimeout(() => {
            document.getElementById('orderSearchInput').focus();
          }, 100);
        }
      })
      .withFailureHandler(function(error) {
        showOrderMessage('ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜: ' + error, 'error');

        // Keep focus on search input
        setTimeout(() => {
          document.getElementById('orderSearchInput').focus();
        }, 100);
      })
      .searchByCodeNum(codeNum);
  }

  function addItemToOrder(item) {
    // ì¬ê³  í™•ì¸
    if (item.stockNum <= 0) {
      showOrderMessage('ì¬ê³ ê°€ ì—†ìŠµë‹ˆë‹¤: ' + item.name, 'error');
      return;
    }
    
    // ì¤‘ë³µ í™•ì¸
    const existingItem = orderItems.find(i => i.codeNum === item.codeNum);
    
    if (existingItem) {
      // ì¬ê³  ì´ˆê³¼ í™•ì¸
      if (existingItem.cnt + 1 > item.stockNum) {
        showOrderMessage('ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. í˜„ì¬ ì¬ê³ : ' + item.stockNum, 'error');
        return;
      }
      existingItem.cnt++;
    } else {
      orderItems.push({
        codeNum: item.codeNum,
        name: item.name,
        description: item.description,
        costB2B: item.costB2B,
        costB2C: item.costB2C,
        stockNum: item.stockNum,
        cnt: 1,
        isB2B: currentOrderType === 'b2b'
      });
    }
    
    renderOrderItems();
    showOrderMessage('í’ˆëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤: ' + item.name, 'success');
  }

  function renderOrderItems() {
    const tbody = document.getElementById('orderItemsBody');
    tbody.innerHTML = '';
    
    orderItems.forEach((item, index) => {
      const cost = item.isB2B ? item.costB2B : item.costB2C;
      
      // âœ… ì²« ë²ˆì§¸ í–‰ (ì½”ë“œë²ˆí˜¸, í’ˆëª…, íƒ€ì…, ê°œìˆ˜, ì‚­ì œ)
      const row1 = tbody.insertRow();
      row1.style.borderBottom = 'none';
      row1.innerHTML = `
        <td rowspan="2" style="vertical-align: middle; font-weight: 600; font-size: 26px;">
          ${item.codeNum}
        </td>
        <td style="font-size: 26px; font-weight: 600; text-align: left; padding: 15px 15px 5px 15px;">
          ${item.name}
        </td>
        <td style="padding: 15px 10px 5px 10px;">
          <div style="display: flex; gap: 8px; align-items: center; justify-content: center;">
            <label style="font-size: 22px; margin: 0;">
              <input type="radio" name="itemType${index}" value="b2c" ${!item.isB2B ? 'checked' : ''} 
                    onchange="updateItemType(${index}, false)" style="width: 18px; height: 18px; vertical-align: middle;"> ì†Œ
            </label>
            <label style="font-size: 22px; margin: 0;">
              <input type="radio" name="itemType${index}" value="b2b" ${item.isB2B ? 'checked' : ''} 
                    onchange="updateItemType(${index}, true)" style="width: 18px; height: 18px; vertical-align: middle;"> ë„
            </label>
          </div>
        </td>
        <td rowspan="2" style="vertical-align: middle;">
          <div class="qty-control">
            <button class="qty-btn" onclick="decreaseQty(${index})">-</button>
            <input type="number" 
              class="qty-input" 
              value="${item.cnt}" 
              min="1" 
              max="${item.stockNum}"
              onchange="updateQty(${index}, this.value)"
              onclick="this.select()"
              style="width: 60px; text-align: center; font-size: 22px; font-weight: 600; border: 1px solid #ddd; border-radius: 4px; padding: 4px;">
            <button class="qty-btn" onclick="increaseQty(${index})">+</button>
          </div>
        </td>
        <td rowspan="2" style="vertical-align: middle;">
          <button class="delete-btn" onclick="removeItem(${index})">ì‚­ì œ</button>
        </td>
      `;
      
      // âœ… ë‘ ë²ˆì§¸ í–‰ (ì„¤ëª…, ê°€ê²©)
      const row2 = tbody.insertRow();
      row2.style.borderBottom = '2px solid #ddd';
      row2.innerHTML = `
        <td style="text-align: left; padding: 5px 15px 15px 15px; font-size: 24px; color: #666;">
          ${item.description || '-'}
        </td>
        <td style="padding: 5px 15px 15px 15px;">
          <strong style="color: #667eea; font-size: 26px;">${cost.toLocaleString()}ì›</strong>
        </td>
      `;
    });
  }

  function updateItemType(index, isB2B) {
    orderItems[index].isB2B = isB2B;
    renderOrderItems();

    // Keep focus on search input
    setTimeout(() => {
      document.getElementById('orderSearchInput').focus();
    }, 100);
  }

  function increaseQty(index) {
    const item = orderItems[index];
    if (item.cnt >= item.stockNum) {
      showOrderMessage('ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. í˜„ì¬ ì¬ê³ : ' + item.stockNum, 'error');
      return;
    }
    item.cnt++;
    renderOrderItems();

    // Keep focus on search input
    setTimeout(() => {
      document.getElementById('orderSearchInput').focus();
    }, 100);
  }

  function decreaseQty(index) {
    const item = orderItems[index];
    if (item.cnt > 1) {
      item.cnt--;
      renderOrderItems();
    }

    // Keep focus on search input
    setTimeout(() => {
      document.getElementById('orderSearchInput').focus();
    }, 100);
  }

  function updateQty(index, newValue) {
    const item = orderItems[index];
    const qty = parseInt(newValue);
    
    // Validate input
    if (isNaN(qty) || qty < 1) {
      showOrderMessage('ìˆ˜ëŸ‰ì€ 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.', 'error');
      renderOrderItems();
      setTimeout(() => {
        document.getElementById('orderSearchInput').focus();
      }, 100);
      return;
    }
    
    if (qty > item.stockNum) {
      showOrderMessage('ì¬ê³ ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. í˜„ì¬ ì¬ê³ : ' + item.stockNum + 'ê°œ', 'error');
      renderOrderItems();
      setTimeout(() => {
        document.getElementById('orderSearchInput').focus();
      }, 100);
      return;
    }
    
    item.cnt = qty;
    renderOrderItems();
    setTimeout(() => {
      document.getElementById('orderSearchInput').focus();
    }, 100);
  }

  function removeItem(index) {
    orderItems.splice(index, 1);
    renderOrderItems();

    // Keep focus on search input
    setTimeout(() => {
      document.getElementById('orderSearchInput').focus();
    }, 100);
  }

  function submitOrder() {
    // âœ… Prevent double submission
    if (isSubmitting) {
      console.log('Already submitting order...');
      return;
    }

    if (orderItems.length === 0) {
      showOrderMessage('ì£¼ë¬¸í•  í’ˆëª©ì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.', 'error');
      return;
    }
    
    // ì €ì¥ëœ ë‚ ì§œì™€ ì¸ë±ìŠ¤ ì‚¬ìš©
    const orderDate = window.currentOrderDate;
    const orderIndex = window.currentOrderIndex;
    
    if (!orderDate || !orderIndex) {
      showOrderMessage('ë‚ ì§œì™€ ì£¼ë¬¸ì„œ ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
      return;
    }
    
    // âœ… NEW: Get selected payment type
    const payType = document.querySelector('input[name="payType"]:checked').value;

    const orderData = {
      date: parseInt(orderDate),
      index: orderIndex,
      payType: payType,  // âœ… NEW
      items: orderItems
    };
    
    // âœ… IDë¡œ ë²„íŠ¼ ì§ì ‘ ì°¸ì¡°
    const submitBtn = document.getElementById('submitOrderBtn');
    
    // ì›ë˜ ë‚´ìš© ì €ì¥
    const originalContent = submitBtn.innerHTML;
    
    // âœ… Set submitting flag
    isSubmitting = true;

    // ë²„íŠ¼ ë¹„í™œì„±í™”
    submitBtn.disabled = true;
    submitBtn.style.opacity = '0.6';
    submitBtn.style.cursor = 'not-allowed';
    submitBtn.textContent = 'â³ ì£¼ë¬¸ ì§„í–‰ì¤‘...';  // textContent ì‚¬ìš©
    
    showOrderMessage('ì£¼ë¬¸ì„ ì²˜ë¦¬í•˜ëŠ” ì¤‘...', 'info');
    
    google.script.run
      .withSuccessHandler(function(result) {
        // âœ… Reset submitting flag
        isSubmitting = false;
        
        // âœ… Invalidate frontend cache
        latestOrderCache = null;
        latestOrderCacheTime = null;
        
        if (result.success) {
          submitBtn.textContent = 'âœ… ì£¼ë¬¸ ì™„ë£Œ!';
          submitBtn.style.opacity = '1';
          showOrderMessage('ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');

          setTimeout(() => {
            // ì£¼ë¬¸ì„œ ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°
            showOrderMain();
            
            // ë²„íŠ¼ ì¬í™œì„±í™”
            submitBtn.disabled = false;
            submitBtn.style.cursor = 'pointer';
            submitBtn.innerHTML = '<span>âœ…</span> ì£¼ë¬¸í•˜ê¸°';
          }, 2000);
        } else {
          submitBtn.disabled = false;
          submitBtn.style.opacity = '1';
          submitBtn.style.cursor = 'pointer';
          submitBtn.innerHTML = originalContent;
          showOrderMessage('ì£¼ë¬¸ ì‹¤íŒ¨: ' + result.message, 'error');

          // Keep focus on search input after error
          setTimeout(() => {
            document.getElementById('orderSearchInput').focus();
          }, 100);
        }
      })
      .withFailureHandler(function(error) {
        // âœ… Reset submitting flag
        isSubmitting = false;

        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
        submitBtn.style.cursor = 'pointer';
        submitBtn.innerHTML = originalContent;
        showOrderMessage('ì£¼ë¬¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜: ' + error, 'error');
      })
      .saveOrder(orderData);
  }

  function showOrderMessage(msg, type) {
    const msgDiv = document.getElementById('orderMessage');
    let className = 'alert-info';
    if (type === 'error') className = 'alert-error';
    if (type === 'success') className = 'alert-success';
    
    msgDiv.innerHTML = '<div class="alert ' + className + '">' + msg + '</div>';
    
    if (type === 'success' || type === 'error') {
      setTimeout(() => {
        msgDiv.innerHTML = '';
      }, 5000);
    }
  }

  // QR ìŠ¤ìºë„ˆ for ì£¼ë¬¸ì„œ
  function toggleOrderQRScanner() {
    const sc = document.getElementById('orderQRScannerContainer');
    const btnText = document.getElementById('orderQRBtnText');
    const captureBtn = document.getElementById('orderQRCaptureBtn');
    
    if (sc.style.display === 'block') {
      stopOrderQRCamera();
      btnText.textContent = 'QR ìŠ¤ìº”';
      captureBtn.style.display = 'none';
    } else {
      startOrderQRCamera();
    }
  }

  async function startOrderQRCamera() {
    await CameraModule.start('orderQR', {
      videoElement: document.getElementById('orderQRVideoElement'),
      containerElement: document.getElementById('orderQRScannerContainer'),
      buttonTextElement: document.getElementById('orderQRBtnText'),
      captureButtonElement: document.getElementById('orderQRCaptureBtn'),
      resultElement: document.getElementById('orderMessage')
    });
  }

  function stopOrderQRCamera() {
    CameraModule.stop('orderQR', {
      videoElement: document.getElementById('orderQRVideoElement'),
      containerElement: document.getElementById('orderQRScannerContainer'),
      captureButtonElement: document.getElementById('orderQRCaptureBtn'),
      buttonTextElement: document.getElementById('orderQRBtnText')
    });
  }

  async function captureOrderQR() {
    try {
      const imgData = CameraModule.captureImage(
        document.getElementById('orderQRVideoElement'),
        document.getElementById('orderQRCanvas')
      );
      
      showOrderMessage('QR ì½”ë“œ ì¸ì‹ ì¤‘...', 'info');
      
      if (typeof jsQR === 'undefined') {
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js';
        s.onload = () => {
          decodeOrderQR(imgData);
        };
        s.onerror = () => {
          showOrderMessage('QR ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        };
        document.head.appendChild(s);
      } else {
        decodeOrderQR(imgData);
      }
    } catch (e) {
      showOrderMessage('QR ì½”ë“œ ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
  }

  function decodeOrderQR(imgData) {
    try {
      const code = jsQR(imgData.data, imgData.width, imgData.height, {inversionAttempts: "dontInvert"});
      if (code) {
        document.getElementById('orderSearchInput').value = code.data;
        stopOrderQRCamera();
        showOrderMessage('QR ì½”ë“œ ì¸ì‹ ì„±ê³µ: ' + code.data, 'success');
        setTimeout(() => searchItemForOrder(), 500);
      } else {
        showOrderMessage('QR ì½”ë“œë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
      }
    } catch (e) {
      showOrderMessage('QR ì½”ë“œ ë””ì½”ë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
    }
  }

  // ===== Modified: showInventoryList function =====
  function showInventoryList() {
    hideAllScreens();
    const s = document.getElementById('listScreen');
    s.style.display = 'block';
    s.classList.add('active');
    stopOrderQRCamera();
    stopInventoryQRCamera();  // âœ… NEW
    
    // Reset search
    inventorySearchText = '';
    document.getElementById('inventorySearchInput').value = '';
    document.getElementById('inventorySearchInfo').innerHTML = '<div class="loading-dot">ë¡œë”© ì¤‘...</div>';
    
    loadAllItems();

    // Auto focus on search input
    setTimeout(() => {
      document.getElementById('inventorySearchInput').focus();
    }, 100);

    navigateToScreen('listScreen');
  }

  function showGuide() {
    hideAllScreens();
    const s = document.getElementById('guideScreen');
    s.style.display = 'block';
    s.classList.add('active');
    stopOrderQRCamera();
    loadGuideImage();
    navigateToScreen('guideScreen');
  }

  function loadGuideImage() {
    var container = document.getElementById('guideImageContainer');
    // ì„œë²„ì—ì„œ GUIDE_IMAGE_ID ê°€ì ¸ì˜¤ê¸°
    google.script.run
      .withSuccessHandler(function(imageId) {
        if (!imageId) {
          container.innerHTML = '<div class="alert alert-error">ê°€ì´ë“œ ì´ë¯¸ì§€ IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br><br>ìŠ¤í¬ë¦½íŠ¸ ì†ì„±ì— GUIDE_IMAGE_IDë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.</div>';
          return;
        }
        
        var urls = [
          'https://drive.google.com/uc?export=download&id=' + imageId,
          'https://lh3.googleusercontent.com/d/' + imageId + '=s0',
          'https://drive.google.com/uc?id=' + imageId + '&export=download',
          'https://drive.google.com/uc?export=view&id=' + imageId
        ];
        
        var currentUrlIndex = 0;
        
        function tryNextUrl() {
          if (currentUrlIndex >= urls.length) {
            container.innerHTML = '<div class="alert alert-error">ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br><br><strong>í•´ê²° ë°©ë²•:</strong><br>1. Google Driveì—ì„œ ì´ë¯¸ì§€ ìš°í´ë¦­<br>2. \'ê³µìœ \' â†’ \'ë§í¬ ë³µì‚¬\'<br>3. ë§í¬ ê¶Œí•œ: "ë§í¬ê°€ ìˆëŠ” ëª¨ë“  ì‚¬ìš©ì"<br>4. íŒŒì¼ ID í™•ì¸: ' + imageId + '<br><br><a href="https://drive.google.com/file/d/' + imageId + '/view" target="_blank" style="color: #c33; text-decoration: underline; font-size: 24px;">ğŸ“‚ Google Driveì—ì„œ ì´ë¯¸ì§€ ì—´ê¸°</a></div>';
            return;
          }
          
          var img = new Image();
          var currentUrl = urls[currentUrlIndex];
          
          console.log('ì´ë¯¸ì§€ ë¡œë“œ ì‹œë„ (' + (currentUrlIndex + 1) + '/' + urls.length + '):', currentUrl);
          
          img.onload = function() {
            console.log('âœ“ ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ:', currentUrl);
            container.innerHTML = '<img src="' + currentUrl + '" alt="ë™ì‘ ê°€ì´ë“œ" class="guide-image">';
          };
          
          img.onerror = function() {
            console.log('âœ— ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ (' + (currentUrlIndex + 1) + '/' + urls.length + '):', currentUrl);
            currentUrlIndex++;
            setTimeout(tryNextUrl, 500);
          };
          
          img.src = currentUrl;
        }
        
        tryNextUrl();
      })
      .withFailureHandler(function(error) {
        container.innerHTML = '<div class="alert alert-error">ì´ë¯¸ì§€ IDë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error + '</div>';
      })
      .getGuideImageId();
  }

  let userIPCache = null;

  async function fetchUserIP() {
    if (userIPCache) {
      return userIPCache;
    }
    
    try {
      const response = await fetch('https://api.ipify.org?format=json');
      const data = await response.json();
      userIPCache = data.ip;
      console.log('âœ“ ì‚¬ìš©ì IP íšë“:', userIPCache);
      return userIPCache;
    } catch (error) {
      console.log('âœ— IP íšë“ ì‹¤íŒ¨, ëŒ€ì²´ ë°©ë²• ì‹œë„...');
      try {
        const response2 = await fetch('https://jsonip.com');
        const data2 = await response2.json();
        userIPCache = data2.ip;
        console.log('âœ“ ì‚¬ìš©ì IP íšë“ (ëŒ€ì²´):', userIPCache);
        return userIPCache;
      } catch (error2) {
        console.log('âœ— IP íšë“ ì™„ì „ ì‹¤íŒ¨');
        return 'Unknown';
      }
    }
  }

  window.addEventListener('load', function() {
    fetchUserIP();
    loadLatestRevision();
    loadDashboardInfo();  // Load dashboard info on page load
    // Set initial history state
    history.replaceState({ screen: 'mainScreen' }, '', '#mainScreen');
  });

  async function logCodeNumAccess(codeNum) {
    const userIP = await fetchUserIP();
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          console.log('âœ“ ì ‘ê·¼ ë¡œê·¸ ê¸°ë¡ ì™„ë£Œ - IP:', userIP, 'ì½”ë“œë²ˆí˜¸:', codeNum);
        } else {
          console.log('âœ— ë¡œê·¸ ê¸°ë¡ ì‹¤íŒ¨:', result.message);
        }
      })
      .withFailureHandler(function(error) {
        console.log('âœ— ë¡œê·¸ ê¸°ë¡ ì˜¤ë¥˜:', error);
      })
      .logAccess(codeNum, userIP);
  }

  // ===== Modified: loadAllItems function =====
  function loadAllItems() {
    showLoading('itemList');
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          allInventoryItems = result.items;
          inventorySearchText = '';
          
          // âœ… Changed: ì „ì²´ ë‹¤ í‘œì‹œ
          renderInventoryItems(allInventoryItems);
          // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
          updateInventorySearchInfo(allInventoryItems.length, allInventoryItems.length);
        } else {
          showError('itemList', result.message);
        }
      })
      .withFailureHandler(e => showError('itemList', 'ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜: ' + e))
      .getAllItems();
  }

  // ===== NEW FUNCTION: Update inventory status counts =====
  function updateInventoryStatusCounts(items) {
    let outCount = 0;      // í’ˆì ˆ (IsShortage === 0)
    let lowCount = 0;      // í’ˆì ˆ ì„ë°• (IsShortage === 1)
    let normalCount = 0;   // ì •ìƒ (IsShortage === 2 or empty)
    
    items.forEach(function(item) {
      const isShortage = item.isShortage;
      
      if (isShortage === 0) {
        outCount++;
      } else if (isShortage === 1) {
        lowCount++;
      } else {
        normalCount++;
      }
    });
    
    // Update UI
    document.getElementById('inventoryOutCount').textContent = outCount + 'ê°œ';
    document.getElementById('inventoryLowCount').textContent = lowCount + 'ê°œ';
    document.getElementById('inventoryNormalCount').textContent = normalCount + 'ê°œ';
  }

  function displayAllItems(r) {
    const c = document.getElementById('itemList');
    if (r.success) {
      allItems = r.items;
      if (allItems.length === 0) {
        c.innerHTML = '<div class="alert alert-info">ë“±ë¡ëœ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }
      renderItems(allItems);
    } else {
      showError('itemList', r.message);
    }
  }

  function renderItems(items) {
    const c = document.getElementById('itemList');
    if (items.length === 0) {
      c.innerHTML = '<div class="alert alert-info">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }
    
    // Helper function to get stock status
    function getStockClass(isShortage) {
      if (isShortage === undefined || isShortage === null || isShortage === '') {
       return 'sufficient'; // Default to sufficient if no value
      }
      if (isShortage === 0) return 'out';
      if (isShortage === 1) return 'low';
      return 'sufficient';
    }
    
    function getStockText(isShortage) {
      if (isShortage === undefined || isShortage === null || isShortage === '') {
        return 'ì–‘í˜¸'; // Default to good if no value
      }
      if (isShortage === 0) return 'í’ˆì ˆ';
      if (isShortage === 1) return 'ë¶€ì¡±';
      return 'ì–‘í˜¸';
    }
    
    let html = '<div class="item-list">';
    items.forEach(function(i) {
      const stockClass = getStockClass(i.isShortage);
      const stockText = getStockText(i.isShortage);
      
      html += '<div class="item-card-new">';
      
      // Header with name and stock badge
      html += '<div class="card-header">';
      html += '<h4>' + (i.name || '-') + '</h4>';
      html += '<span class="stock-badge ' + stockClass + '">' + stockText + '</span>';
      html += '</div>';
      
      // Description
      html += '<p class="description">' + (i.description || '-') + '</p>';
      
      // Info grid (2x2)
      html += '<div class="info-grid">';
      
      // Code number
      html += '<div>';
      html += '<span class="label">ì½”ë“œë²ˆí˜¸:</span> ';
      html += '<span class="value code">' + (i.codeNum || '-') + '</span>';
      html += '</div>';
      
      // Stock
      html += '<div>';
      html += '<span class="label">ì¬ê³ :</span> ';
      html += '<span class="value stock-value ' + stockClass + '">' + (i.stockNum ?? '-') + 'ê°œ</span>';
      html += '</div>';
      
      // B2B price
      html += '<div>';
      html += '<span class="label">ë„ë§¤ê°€:</span> ';
      html += '<span class="value">' + (i.costB2B ? i.costB2B.toLocaleString() + 'ì›' : '-') + '</span>';
      html += '</div>';
      
      // B2C price
      html += '<div>';
      html += '<span class="label">ì†Œë§¤ê°€:</span> ';
      html += '<span class="value">' + (i.costB2C ? i.costB2C.toLocaleString() + 'ì›' : '-') + '</span>';
      html += '</div>';
      
      html += '</div>'; // End info-grid
      html += '</div>'; // End item-card-new
    });
    html += '</div>';
    
    c.innerHTML = html;
  }

  function showLoading(id) {
    document.getElementById(id).innerHTML = '<div class="loading"><div class="spinner"></div><div>ë¡œë”© ì¤‘...</div></div>';
  }

  function showError(id, msg) {
    document.getElementById(id).innerHTML = '<div class="alert alert-error">' + msg + '</div>';
  }

  function loadLatestRevision() {
    google.script.run
      .withSuccessHandler(function(result) {
        const revisionText = document.getElementById('revisionText');
        if (result.success) {
          revisionText.innerHTML = `Revision <strong>${result.revision}</strong> (last update <strong>${result.date}</strong>)`;
        } else {
          revisionText.textContent = 'Revision ì •ë³´ ì—†ìŒ';
          console.log('Revision ë¡œë“œ ì‹¤íŒ¨:', result.message);
        }
      })
      .withFailureHandler(function(error) {
        document.getElementById('revisionText').textContent = 'Revision ë¡œë“œ ì‹¤íŒ¨';
        console.log('Revision ë¡œë“œ ì˜¤ë¥˜:', error);
      })
      .getLatestRevision();
  }

  function showRevisionHistory() {
    hideAllScreens();
    const s = document.getElementById('revisionHistoryScreen');
    s.style.display = 'block';
    s.classList.add('active');
    loadRevisionHistory();
    navigateToScreen('revisionHistoryScreen');
  }

  function loadRevisionHistory() {
    showLoading('revisionHistoryContent');
    google.script.run
      .withSuccessHandler(displayRevisionHistory)
      .withFailureHandler(function(error) {
        showError('revisionHistoryContent', 'Revision History ë¡œë“œ ì˜¤ë¥˜: ' + error);
      })
      .getRevisionHistory();
  }

  function displayRevisionHistory(result) {
    const container = document.getElementById('revisionHistoryContent');
    
    if (!result.success) {
      showError('revisionHistoryContent', result.message);
      return;
    }

    if (result.revisions.length === 0) {
      container.innerHTML = '<div class="alert alert-info">Revision ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }

    let tableHTML = '<div style="overflow-x: auto;"><table class="revision-table"><thead><tr>';
    
    result.headers.forEach(header => {
      tableHTML += `<th>${header}</th>`;
    });
    tableHTML += '</tr></thead><tbody>';

    result.revisions.forEach(revision => {
      tableHTML += '<tr>';
      result.headers.forEach(header => {
        const value = revision[header] !== undefined && revision[header] !== null ? revision[header] : '-';
        tableHTML += `<td>${value}</td>`;
      });
      tableHTML += '</tr>';
    });

    tableHTML += '</tbody></table></div>';
    container.innerHTML = tableHTML;
  }
  
  // ===== Memo Functions =====
  function showMemo() {
    hideAllScreens();
    const s = document.getElementById('memoScreen');
    s.style.display = 'block';
    s.classList.add('active');
    stopOrderQRCamera();
    
    // Set today's date
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth() + 1;
    const day = today.getDate();
    document.getElementById('memoTodayDate').textContent = `ğŸ“… ${year}ë…„ ${month}ì›” ${day}ì¼`;
    
    // Clear textarea
    document.getElementById('memoTextarea').value = '';
    document.getElementById('memoMessage').innerHTML = '';
    
    // Load memos
    loadMemos();
    
    navigateToScreen('memoScreen');
  }

  function loadMemos() {
    document.getElementById('memoListContainer').innerHTML = '<div class="loading"><div class="spinner"></div><div>ë©”ëª¨ ë¡œë”© ì¤‘...</div></div>';
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          displayMemos(result.memos);
        } else {
          document.getElementById('memoListContainer').innerHTML = '<div class="alert alert-error">' + result.message + '</div>';
        }
      })
      .withFailureHandler(function(error) {
        document.getElementById('memoListContainer').innerHTML = '<div class="alert alert-error">ë©”ëª¨ ë¡œë“œ ì¤‘ ì˜¤ë¥˜: ' + error + '</div>';
      })
      .getLatestMemos();
  }

  function displayMemos(memos) {
    const container = document.getElementById('memoListContainer');
    
    if (memos.length === 0) {
      container.innerHTML = '<div class="alert alert-info">ì•„ì§ ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }
    
    let html = '';
    
    memos.forEach(function(memo) {
      const dateStr = memo.date.toString();
      const year = dateStr.substring(0, 4);
      const month = dateStr.substring(4, 6);
      const day = dateStr.substring(6, 8);
      const formattedDate = `${year}-${month}-${day}`;
      
      html += '<div class="memo-card" id="memoCard' + memo.rowNumber + '">';
      html += '<div class="memo-card-header">';
      html += '<div class="memo-date">' + formattedDate + ' #' + memo.index + '</div>';
      html += '<div class="memo-actions">';
      html += '<button class="btn-memo-action" onclick="editMemo(' + memo.rowNumber + ', \'' + memo.content.replace(/'/g, "\\'").replace(/\n/g, "\\n") + '\')">âœï¸ ìˆ˜ì •</button>';
      html += '<button class="btn-memo-action" onclick="confirmDeleteMemo(' + memo.rowNumber + ')">ğŸ—‘ï¸ ì‚­ì œ</button>';
      html += '</div>';
      html += '</div>';
      html += '<div class="memo-content" id="memoContent' + memo.rowNumber + '">' + memo.content.replace(/\n/g, '<br>') + '</div>';
      html += '<div class="memo-edit-area" id="memoEdit' + memo.rowNumber + '" style="display:none;">';
      html += '<textarea class="memo-textarea" id="memoEditText' + memo.rowNumber + '" rows="3"></textarea>';
      html += '<div style="display: flex; gap: 8px; margin-top: 10px;">';
      html += '<button class="btn btn-primary btn-small" onclick="saveEditedMemo(' + memo.rowNumber + ')">ğŸ’¾ ì €ì¥</button>';
      html += '<button class="btn btn-secondary btn-small" onclick="cancelEdit(' + memo.rowNumber + ')">âŒ ì·¨ì†Œ</button>';
      html += '</div>';
      html += '</div>';
      html += '</div>';
    });
    
    container.innerHTML = html;
  }

  function saveMemo() {
    const content = document.getElementById('memoTextarea').value.trim();
    
    if (!content) {
      showMemoMessage('ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
      return;
    }
    
    showMemoMessage('ë©”ëª¨ ì €ì¥ ì¤‘...', 'info');
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          showMemoMessage('ë©”ëª¨ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
          document.getElementById('memoTextarea').value = '';
          loadMemos();
        } else {
          showMemoMessage('ì €ì¥ ì‹¤íŒ¨: ' + result.message, 'error');
        }
      })
      .withFailureHandler(function(error) {
        showMemoMessage('ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + error, 'error');
      })
      .addMemo(content);
  }

  function editMemo(rowNumber, content) {
    // Hide content, show edit area
    document.getElementById('memoContent' + rowNumber).style.display = 'none';
    document.getElementById('memoEdit' + rowNumber).style.display = 'block';
    document.getElementById('memoEditText' + rowNumber).value = content;
  }

  function cancelEdit(rowNumber) {
    // Show content, hide edit area
    document.getElementById('memoContent' + rowNumber).style.display = 'block';
    document.getElementById('memoEdit' + rowNumber).style.display = 'none';
  }

  function saveEditedMemo(rowNumber) {
    const newContent = document.getElementById('memoEditText' + rowNumber).value.trim();
    
    if (!newContent) {
      alert('ë©”ëª¨ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    showMemoMessage('ë©”ëª¨ ìˆ˜ì • ì¤‘...', 'info');
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          showMemoMessage('ë©”ëª¨ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
          loadMemos();
        } else {
          showMemoMessage('ìˆ˜ì • ì‹¤íŒ¨: ' + result.message, 'error');
        }
      })
      .withFailureHandler(function(error) {
        showMemoMessage('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜: ' + error, 'error');
      })
      .updateMemo(rowNumber, newContent);
  }

  function confirmDeleteMemo(rowNumber) {
    if (confirm('ì´ ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      deleteMemoById(rowNumber);
    }
  }

  function deleteMemoById(rowNumber) {
    showMemoMessage('ë©”ëª¨ ì‚­ì œ ì¤‘...', 'info');
    
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          showMemoMessage('ë©”ëª¨ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
          loadMemos();
        } else {
          showMemoMessage('ì‚­ì œ ì‹¤íŒ¨: ' + result.message, 'error');
        }
      })
      .withFailureHandler(function(error) {
        showMemoMessage('ì‚­ì œ ì¤‘ ì˜¤ë¥˜: ' + error, 'error');
      })
      .deleteMemo(rowNumber);
  }

  function showMemoMessage(msg, type) {
    const msgDiv = document.getElementById('memoMessage');
    let className = 'alert-info';
    if (type === 'error') className = 'alert-error';
    if (type === 'success') className = 'alert-success';
    
    msgDiv.innerHTML = '<div class="alert ' + className + '">' + msg + '</div>';
    
    if (type === 'success' || type === 'error') {
      setTimeout(() => {
        msgDiv.innerHTML = '';
      }, 3000);
    }
  }

  // ===== Dashboard Functions =====
  function loadDashboardInfo() {
    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          // Update date
          document.getElementById('dashboardDate').textContent = result.todayDate;
          
          // Update order count
          document.getElementById('dashboardOrderCount').textContent = result.orderCount + 'ê±´';
          
          // Update stock status
          const statusElement = document.getElementById('dashboardStockStatus');
          let statusHTML = '';
          
          if (result.stockStatus === 0) {
            // ê²½ê³  (í’ˆì ˆ ìˆìŒ)
            statusHTML = '<span class="status-badge status-critical">ğŸ”´ ê²½ê³ </span>';
          } else if (result.stockStatus === 1) {
            // ê´€ì‹¬ (ë¶€ì¡± ìˆìŒ)
            statusHTML = '<span class="status-badge status-warning">ğŸŸ  ê´€ì‹¬</span>';
          } else {
            // ì–‘í˜¸
            statusHTML = '<span class="status-badge status-good">ğŸŸ¢ ì–‘í˜¸</span>';
          }
          
          statusElement.innerHTML = statusHTML;
        } else {
          console.error('Failed to load dashboard info:', result.message);
        }
      })
      .withFailureHandler(function(error) {
        console.error('Error loading dashboard info:', error);
      })
      .getDashboardInfo();
  }

  // For Input Timer.
  function handleInventorySearch() {
    // Cancel previous timer if exists
    if (inventorySearchTimeout) {
      clearTimeout(inventorySearchTimeout);
    }
    
    // Execute search after 300ms delay
    inventorySearchTimeout = setTimeout(() => {
      executeInventorySearch();
    }, 500);  // 500ms = 0.5 sec delay
  }

  // Execute inventory search
  function executeInventorySearch() {
    const searchInput = document.getElementById('inventorySearchInput');
    inventorySearchText = searchInput.value.trim().toLowerCase();
    
    if (inventorySearchText === '') {
      // ê²€ìƒ‰ì–´ ì—†ìœ¼ë©´ ì „ì²´ í‘œì‹œ
      renderInventoryItems(allInventoryItems);
      updateInventorySearchInfo(allInventoryItems.length, allInventoryItems.length);
    } else {
      // ì „ì²´ì—ì„œ í•„í„°ë§
      const filtered = allInventoryItems.filter(item => 
        (item.name && item.name.toLowerCase().includes(inventorySearchText)) ||
        (item.codeNum && item.codeNum.toString().includes(inventorySearchText)) ||
        (item.description && item.description.toLowerCase().includes(inventorySearchText))
      );
      
      renderInventoryItems(filtered);
      updateInventorySearchInfo(filtered.length, allInventoryItems.length);
    }
  }

  // ===== NEW: renderInventoryItems function =====
  function renderInventoryItems(items) {
    const c = document.getElementById('itemList');
    if (items.length === 0) {
      c.innerHTML = '<div class="alert alert-info">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }
    
    // Helper functions
    function getStockClass(isShortage) {
      if (isShortage === undefined || isShortage === null || isShortage === '') {
        return 'sufficient';
      }
      if (isShortage === 0) return 'out';
      if (isShortage === 1) return 'low';
      return 'sufficient';
    }
    
    function getStockText(isShortage) {
      if (isShortage === undefined || isShortage === null || isShortage === '') {
        return 'ì–‘í˜¸';
      }
      if (isShortage === 0) return 'í’ˆì ˆ';
      if (isShortage === 1) return 'ë¶€ì¡±';
      return 'ì–‘í˜¸';
    }
    
    let html = '<div class="item-list">';
    items.forEach(function(i) {
      const stockClass = getStockClass(i.isShortage);
      const stockText = getStockText(i.isShortage);
      
      html += '<div class="item-card-new">';
      
      // Header with name and stock badge
      html += '<div class="card-header">';
      html += '<h4>' + (i.name || '-') + '</h4>';
      html += '<span class="stock-badge ' + stockClass + '">' + stockText + '</span>';
      html += '</div>';
      
      // Description
      html += '<p class="description">' + (i.description || '-') + '</p>';
      
      // Info grid (2x2)
      html += '<div class="info-grid">';
      
      // Code number
      html += '<div>';
      html += '<span class="label">ì½”ë“œë²ˆí˜¸:</span> ';
      html += '<span class="value code">' + (i.codeNum || '-') + '</span>';
      html += '</div>';
      
      // Stock
      html += '<div>';
      html += '<span class="label">ì¬ê³ :</span> ';
      html += '<span class="value stock-value ' + stockClass + '">' + (i.stockNum ?? '-') + 'ê°œ</span>';
      html += '</div>';
      
      // B2B price
      html += '<div>';
      html += '<span class="label">ë„ë§¤ê°€:</span> ';
      html += '<span class="value">' + (i.costB2B ? i.costB2B.toLocaleString() + 'ì›' : '-') + '</span>';
      html += '</div>';
      
      // B2C price
      html += '<div>';
      html += '<span class="label">ì†Œë§¤ê°€:</span> ';
      html += '<span class="value">' + (i.costB2C ? i.costB2C.toLocaleString() + 'ì›' : '-') + '</span>';
      html += '</div>';
      
      html += '</div>'; // End info-grid
      html += '</div>'; // End item-card-new
    });
    html += '</div>';
    
    c.innerHTML = html;
  }

  // ===== NEW: updateInventorySearchInfo function =====
  function updateInventorySearchInfo(displayCount, totalCount) {
    const infoDiv = document.getElementById('inventorySearchInfo');
  
    if (inventorySearchText === '') {
      // âœ… Changed: ì „ì²´ í‘œì‹œ ì¤‘
      infoDiv.innerHTML = 'ì „ì²´ <strong>' + totalCount + '</strong>ê°œ';
    } else {
      // ê²€ìƒ‰ ê²°ê³¼
      infoDiv.innerHTML = 'ê²€ìƒ‰ ê²°ê³¼: <strong>' + displayCount + '</strong>ê°œ / ì „ì²´ <strong>' + totalCount + '</strong>ê°œ';
    }
  }

  // ===== NEW: QR Scanner for Inventory =====
  function toggleInventoryQRScanner() {
    const container = document.getElementById('inventoryQRScannerContainer');
    const btnText = document.getElementById('inventoryQRBtnText');
    const captureBtn = document.getElementById('inventoryQRCaptureBtn');
    
    if (container.style.display === 'block') {
      stopInventoryQRCamera();
    } else {
      startInventoryQRCamera();
    }
  }

  async function startInventoryQRCamera() {
    await CameraModule.start('inventoryQR', {
      videoElement: document.getElementById('inventoryQRVideoElement'),
      containerElement: document.getElementById('inventoryQRScannerContainer'),
      buttonTextElement: document.getElementById('inventoryQRBtnText'),
      captureButtonElement: document.getElementById('inventoryQRCaptureBtn'),
      resultElement: null
    });
  }

  function stopInventoryQRCamera() {
    CameraModule.stop('inventoryQR', {
      videoElement: document.getElementById('inventoryQRVideoElement'),
      containerElement: document.getElementById('inventoryQRScannerContainer'),
      captureButtonElement: document.getElementById('inventoryQRCaptureBtn'),
      buttonTextElement: document.getElementById('inventoryQRBtnText')
    });
  }

  async function captureInventoryQR() {
    try {
      const imgData = CameraModule.captureImage(
        document.getElementById('inventoryQRVideoElement'),
        document.getElementById('inventoryQRCanvas')
      );
      
      if (typeof jsQR === 'undefined') {
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js';
        s.onload = () => {
          decodeInventoryQR(imgData);
        };
        s.onerror = () => {
          alert('QR ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        };
        document.head.appendChild(s);
      } else {
        decodeInventoryQR(imgData);
      }
    } catch (e) {
      alert('QR ì½”ë“œ ì¸ì‹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }

  function decodeInventoryQR(imgData) {
    try {
      const code = jsQR(imgData.data, imgData.width, imgData.height, {inversionAttempts: "dontInvert"});
      if (code) {
        document.getElementById('inventorySearchInput').value = code.data;
        stopInventoryQRCamera();
        handleInventorySearch();

        // Focus back to search input after QR scan
        setTimeout(() => {
          document.getElementById('inventorySearchInput').focus();
        }, 100);
      } else {
        alert('QR ì½”ë“œë¥¼ ì¸ì‹í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      }
    } catch (e) {
      alert('QR ì½”ë“œ ë””ì½”ë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
  }

  // ===== Order Tab Functions =====
  function switchOrderTab(tabName) {
    // Remove active class from all tabs and contents
    document.querySelectorAll('.order-tab').forEach(tab => {
      tab.classList.remove('active');
    });
    document.querySelectorAll('.order-tab-content').forEach(content => {
      content.classList.remove('active');
    });
    
    // Add active class to selected tab and content
    document.querySelector(`.order-tab[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(`orderTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
    
    // Update tab info based on selection
    updateTabInfo();
  }

  function updateTabInfo() {
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth() + 1;
    const day = today.getDate();
    
    // Today tab
    document.getElementById('todayTabDate').textContent = `${year}ë…„ ${month}ì›” ${day}ì¼`;
    
    // Week tab - get Monday of this week
    const dayOfWeek = today.getDay();
    const monday = new Date(today);
    monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
    
    const mondayYear = monday.getFullYear();
    const mondayMonth = monday.getMonth() + 1;
    const mondayDay = monday.getDate();
    
    document.getElementById('weekTabDate').textContent = 
      `${mondayYear}ë…„ ${mondayMonth}ì›” ${mondayDay}ì¼ ~ ${year}ë…„ ${month}ì›” ${day}ì¼`;
    
    // Month tab
    document.getElementById('monthTabDate').textContent = `${year}ë…„ ${month}ì›” 1ì¼ ~ ${year}ë…„ ${month}ì›” ${day}ì¼`;
  }

  function searchOrderToday() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const orderDate = year + month + day;
    
    // âœ… Add loading message
    showLoadingMessage('ì˜¤ëŠ˜ ì£¼ë¬¸ì„œë¥¼ ì¡°íšŒí•˜ëŠ” ì¤‘...');

    // Search all orders for today
    google.script.run
      .withSuccessHandler(function(result) {
        hideLoadingMessage();  // âœ… Hide loading

        if (result.success) {
          hideAllScreens();
          const s = document.getElementById('orderViewScreen');
          s.style.display = 'block';
          s.classList.add('active');
          displayOrderList(orderDate, result.orderList);
          navigateToScreen('orderViewScreen');
        } else {
          alert(result.message);
        }
      })
      .withFailureHandler(function(error) {
        hideLoadingMessage();  // âœ… Hide loading on error
        alert('ì£¼ë¬¸ì„œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜: ' + error);
      })
      .getOrderListByDate(orderDate);
  }

  function searchOrderWeek() {
    const today = new Date();
    const dayOfWeek = today.getDay();
    const monday = new Date(today);
    monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
    
    const startDate = monday.getFullYear() + 
                    String(monday.getMonth() + 1).padStart(2, '0') + 
                    String(monday.getDate()).padStart(2, '0');
  
    const endDate = today.getFullYear() + 
                    String(today.getMonth() + 1).padStart(2, '0') + 
                    String(today.getDate()).padStart(2, '0');
    
    showLoadingMessage('ì´ë²ˆì£¼ ì£¼ë¬¸ì„œë¥¼ ì¡°íšŒí•˜ëŠ” ì¤‘...');

    // âœ… Single request for entire week
    google.script.run
      .withSuccessHandler(function(result) {
        hideLoadingMessage();
        
        if (result.success) {
          if (result.orderGroups.length === 0) {
            alert('ì´ë²ˆì£¼ ì£¼ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }
          
          hideAllScreens();
          const s = document.getElementById('orderViewScreen');
          s.style.display = 'block';
          s.classList.add('active');
          displayMultipleDateOrders(result.orderGroups, 'ì´ë²ˆì£¼');
          navigateToScreen('orderViewScreen');
        } else {
          alert(result.message);
        }
      })
      .withFailureHandler(function(error) {
        hideLoadingMessage();
        alert('ì£¼ë¬¸ì„œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜: ' + error);
      })
      .getOrdersByDateRange(startDate, endDate);
  }

  function searchOrderMonth() {
    const today = new Date();
    const year = today.getFullYear();
    const month = today.getMonth() + 1;
    const day = today.getDate();
    
    const startDate = year + String(month).padStart(2, '0') + '01';
    const endDate = year + String(month).padStart(2, '0') + String(day).padStart(2, '0');
  
    showLoadingMessage('ì´ë²ˆë‹¬ ì£¼ë¬¸ì„œë¥¼ ì¡°íšŒí•˜ëŠ” ì¤‘...');
  
    // âœ… Single request for entire month
    google.script.run
      .withSuccessHandler(function(result) {
        hideLoadingMessage();
        
        if (result.success) {
          if (result.orderGroups.length === 0) {
            alert('ì´ë²ˆë‹¬ ì£¼ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }
          
          hideAllScreens();
          const s = document.getElementById('orderViewScreen');
          s.style.display = 'block';
          s.classList.add('active');
          displayMultipleDateOrders(result.orderGroups, 'ì´ë²ˆë‹¬');
          navigateToScreen('orderViewScreen');
        } else {
          alert(result.message);
        }
      })
      .withFailureHandler(function(error) {
        hideLoadingMessage();
        alert('ì£¼ë¬¸ì„œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜: ' + error);
      })
      .getOrdersByDateRange(startDate, endDate);
  }

  function searchOrderCustom() {
    const year = document.getElementById('searchOrderYear').value;
    const month = String(document.getElementById('searchOrderMonth').value).padStart(2, '0');
    const day = String(document.getElementById('searchOrderDay').value).padStart(2, '0');
    const orderIndexInput = document.getElementById('searchOrderIndex').value.trim();
    
    if (!year || !month || !day) {
      alert('ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    
    const orderDate = year + month + day;
    
    // ì£¼ë¬¸ì„œ ë²ˆí˜¸ê°€ ë¹„ì–´ìˆìœ¼ë©´ ì „ì²´ ì¡°íšŒ
    if (!orderIndexInput || orderIndexInput === '') {
      // âœ… Add loading message for list query
      showLoadingMessage('ì£¼ë¬¸ì„œë¥¼ ì¡°íšŒí•˜ëŠ” ì¤‘...');

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoadingMessage();  // âœ… Hide loading
          if (result.success) {
            hideAllScreens();
            const s = document.getElementById('orderViewScreen');
            s.style.display = 'block';
            s.classList.add('active');
            displayOrderList(orderDate, result.orderList);
            navigateToScreen('orderViewScreen');
          } else {
            alert(result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoadingMessage();  // âœ… Hide loading on error
          alert('ì£¼ë¬¸ì„œ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜: ' + error);
        })
        .getOrderListByDate(orderDate);
    } else {
      // ê°œë³„ ì¡°íšŒ
      const orderIndex = parseInt(orderIndexInput);
      
      // âœ… Add loading message for single query
      showLoadingMessage('ì£¼ë¬¸ì„œ ìƒì„¸ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');

      google.script.run
        .withSuccessHandler(function(result) {
          hideLoadingMessage();  // âœ… Hide loading
          if (result.success) {
            hideAllScreens();
            const s = document.getElementById('orderViewScreen');
            s.style.display = 'block';
            s.classList.add('active');
            displayOrderView(result.orders);
            navigateToScreen('orderViewScreen');
          } else {
            alert(result.message);
          }
        })
        .withFailureHandler(function(error) {
          hideLoadingMessage();  // âœ… Hide loading on error
          alert('ì£¼ë¬¸ì„œ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜: ' + error);
        })
        .getOrderData(orderDate, orderIndex);
    }
  }

  function displayMultipleDateOrders(orderDetailsList, periodName) {
    let totalAmount = 0;
    let totalItems = 0;
    let totalQty = 0;
    
    // Calculate totals
    orderDetailsList.forEach(function(orderGroup) {
      orderGroup.orders.forEach(function(order) {
        totalAmount += order.totalCost || 0;
        totalQty += order.cnt || 0;
      });
      totalItems += orderGroup.orders.length;
    });
    
    // Header
    let html = '<div style="background: white; padding: 30px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04); border: 2px solid #e8ecef; border-left: 5px solid #3498db;">';
    html += '<div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">';
    html += '<span style="font-size: 42px;">ğŸ“‹</span>';
    html += '<div>';
    html += '<h2 style="font-size: 38px; color: #2c3e50; margin: 0; font-weight: 700;">' + periodName + ' ì£¼ë¬¸ì„œ ëª©ë¡</h2>';
    html += '<div style="color: #7f8c8d; font-size: 18px; margin-top: 8px;">ì´ <strong style="color: #3498db;">' + orderDetailsList.length + '</strong>ê°œ ì£¼ë¬¸ì„œ</div>';
    html += '</div>';
    html += '</div>';
    html += '</div>';
    
    // Display each order
    orderDetailsList.forEach(function(orderGroup) {
      const orderSerialNumber = orderGroup.orders[0].serialNumber;
      const orderTime = orderGroup.orders[0].time || '-';
      const payType = orderGroup.orders[0].payType || '-';
      const isCanceled = orderGroup.orders[0].isCanceled === true;
      
      const dateStr = orderGroup.date.toString();
      const year = dateStr.substring(0, 4);
      const month = dateStr.substring(4, 6);
      const day = dateStr.substring(6, 8);
      const formattedDate = `${year}ë…„ ${parseInt(month)}ì›” ${parseInt(day)}ì¼`;
      
      let orderAmount = 0;
      let orderQty = 0;
      
      orderGroup.orders.forEach(function(order) {
        orderAmount += order.totalCost || 0;
        orderQty += order.cnt || 0;
      });

      const cardBorder = isCanceled ? 'border: 2px solid #fee2e2; border-left: 5px solid #dc2626;' : 'border: 2px solid #e8ecef; border-left: 5px solid #3498db;';
      const titleColor = isCanceled ? '#dc2626' : '#2c3e50';
      const accentColor = isCanceled ? '#dc2626' : '#3498db';

      html += '<div style="background: white; ' + cardBorder + ' padding: 25px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);">';
      
      // Header with cancel badge or button
      html += '<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">';
      html += '<div>';
      html += '<h3 style="font-size: 28px; color: ' + titleColor + '; margin: 0 0 8px 0; font-weight: 700;">';
      html += orderSerialNumber;  // âœ… 202511030001
      html += '</h3>';
      html += '</div>';
      
      // âœ… ì˜ìˆ˜ì¦ ë²„íŠ¼ ì¶”ê°€
      html += '<div style="display: flex; gap: 8px;">';
      if (isCanceled) {
        html += '<div style="background: #fee2e2; color: #dc2626; padding: 8px 16px; border-radius: 8px; font-weight: 600; font-size: 16px; white-space: nowrap; height: fit-content;">âŒ ì·¨ì†Œë¨</div>';
      } else {
        html += '<button class="btn btn-secondary btn-small" onclick="generateReceiptFromList(\'' + orderSerialNumber + '\')" style="margin: 0; white-space: nowrap; height: fit-content;">ğŸ“„ ì˜ìˆ˜ì¦</button>';
        html += '<button class="btn btn-secondary btn-small" onclick="confirmCancelOrderFromList(\'' + orderSerialNumber + '\', \'' + orderGroup.date + '\')" style="margin: 0; white-space: nowrap; height: fit-content;">âŒ ì·¨ì†Œ</button>';
      }
      html += '</div>';
      html += '</div>';
      
      // Simple text info
      html += '<div style="color: #7f8c8d; font-size: 18px; line-height: 1.8; margin-bottom: 20px;">';
      html += 'ì£¼ë¬¸ ì‹œê°„: <strong style="color: #2c3e50;">' + orderTime + '</strong><br>';
      html += 'ì£¼ë¬¸ ê¸ˆì•¡: <strong style="color: ' + accentColor + ';">' + orderAmount.toLocaleString() + 'ì›</strong> (' + payType + ')';
      html += '</div>';
      
      html += '<div style="overflow-x: auto;">';
      html += '<table class="order-table">';
      html += '<thead>';
      html += '<tr style="border-bottom: none;">';
      html += '<th rowspan="2" style="vertical-align: middle; width: 15%;">ì½”ë“œë²ˆí˜¸</th>';
      html += '<th style="padding-bottom: 8px; width: 35%;">í’ˆëª…</th>';
      html += '<th style="padding-bottom: 8px; width: 20%;">íƒ€ì…</th>';
      html += '<th style="padding-bottom: 8px; width: 15%;">ê°œìˆ˜</th>';
      html += '</tr>';
      html += '<tr>';
      html += '<th style="padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">ì„¤ëª…</th>';
      html += '<th style="padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">ê°€ê²©</th>';
      html += '<th style="padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.3);">ì´ê°€ê²©</th>';
      html += '</tr>';
      html += '</thead>';
      html += '<tbody>';
      
      orderGroup.orders.forEach(function(order) {
        const cost = order.isB2B === 1 ? order.costB2B : order.costB2C;
        const textStyle = isCanceled ? 'text-decoration: line-through; opacity: 0.5;' : '';
      
        // First row
        html += '<tr style="border-bottom: none;">';
        html += '<td rowspan="2" style="vertical-align: middle; font-weight: 600; font-size: 18px; ' + textStyle + '">';
        html += order.codeNum;
        html += '</td>';
        html += '<td style="font-size: 18px; font-weight: 600; text-align: left; padding: 15px 15px 5px 15px; ' + textStyle + '">';
        html += order.name;
        html += '</td>';
        html += '<td style="padding: 15px 10px 5px 10px; text-align: center; ' + textStyle + '">';
        html += order.isB2B === 1 ? 'ë„' : 'ì†Œ';
        html += '</td>';
        html += '<td style="vertical-align: middle; font-size: 18px; text-align: center; padding: 15px 10px 5px 10px; ' + textStyle + '">';
        html += order.cnt;
        html += '</td>';
        html += '</tr>';
        
        // Second row
        html += '<tr style="border-bottom: 2px solid #ddd;">';
        html += '<td style="text-align: left; padding: 5px 15px 15px 15px; font-size: 16px; color: #666; ' + textStyle + '">';
        html += order.description || '-';
        html += '</td>';
        html += '<td style="padding: 5px 15px 15px 15px; text-align: center; ' + textStyle + '">';
        html += '<strong style="color: ' + accentColor + '; font-size: 18px;">' + cost.toLocaleString() + 'ì›</strong>';
        html += '</td>';
        html += '<td style="padding: 5px 15px 15px 15px; text-align: center; ' + textStyle + '">';
        html += '<strong style="color: ' + accentColor + '; font-size: 18px;">' + order.totalCost.toLocaleString() + 'ì›</strong>';
        html += '</td>';
        html += '</tr>';
      });
      
      html += '</tbody>';
      html += '</table>';
      html += '</div>';
      html += '</div>';
    });
    
    // Summary card
    html += '<div style="background: white; padding: 30px; border-radius: 16px; margin-top: 20px; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04); border: 2px solid #e3f2fd; border-left: 5px solid #3498db;">';
    html += '<h3 style="font-size: 24px; color: #2c3e50; margin-bottom: 20px; font-weight: 600;">ğŸ“Š ' + periodName + ' ì „ì²´ í•©ê³„</h3>';
    html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">';
    
    html += '<div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">';
    html += '<div style="color: #7f8c8d; font-size: 16px; margin-bottom: 8px;">ì´ ì£¼ë¬¸ ê¸ˆì•¡</div>';
    html += '<div style="color: #3498db; font-size: 32px; font-weight: 700;">' + totalAmount.toLocaleString() + 'ì›</div>';
    html += '</div>';
    
    html += '<div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">';
    html += '<div style="color: #7f8c8d; font-size: 16px; margin-bottom: 8px;">ì´ í’ˆëª© ìˆ˜</div>';
    html += '<div style="color: #2c3e50; font-size: 32px; font-weight: 700;">' + totalItems + 'ê°œ</div>';
    html += '</div>';
    
    html += '<div style="background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center;">';
    html += '<div style="color: #7f8c8d; font-size: 16px; margin-bottom: 8px;">ì´ ìˆ˜ëŸ‰</div>';
    html += '<div style="color: #2c3e50; font-size: 32px; font-weight: 700;">' + totalQty + 'ê°œ</div>';
    html += '</div>';
    
    html += '</div>';
    html += '</div>';
    
    document.getElementById('orderViewContent').innerHTML = html;
  }

  function showLoadingMessage(message) {
    let overlay = document.getElementById('loadingOverlay');
    
    if (overlay) {
      // âœ… Update existing message
      const textElement = overlay.querySelector('.loading-text');
      if (textElement) {
        textElement.textContent = message;
      }
      return;
    }
    
    // Create new overlay
    overlay = document.createElement('div');
    overlay.id = 'loadingOverlay';
    overlay.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999;';
    
    const box = document.createElement('div');
    box.style.cssText = 'background: white; padding: 30px 40px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); text-align: center;';
    
    const spinner = document.createElement('div');
    spinner.className = 'spinner';
    spinner.style.margin = '0 auto 20px auto';
    
    const text = document.createElement('div');
    text.className = 'loading-text';  // âœ… Add class for updates
    text.style.cssText = 'font-size: 18px; color: #2c3e50; font-weight: 600;';
    text.textContent = message;
    
    box.appendChild(spinner);
    box.appendChild(text);
    overlay.appendChild(box);
    document.body.appendChild(overlay);
  }

  function hideLoadingMessage() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) {
      overlay.remove();
    }
  }

  // Generate receipt from order view screen
  function generateReceiptFromView(orderSerialNumber) {
    showLoadingMessage('ì˜ìˆ˜ì¦ì„ ìƒì„±í•˜ëŠ” ì¤‘...');
    
    google.script.run
      .withSuccessHandler(function(result) {
        hideLoadingMessage();
        
        if (result.success) {
          let message = `ì˜ìˆ˜ì¦ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\n\n`;
          message += `ìƒì„±ëœ íŒŒì¼: ${result.count}ê°œ\n\n`;
          
          result.files.forEach((file, index) => {
            message += `${index + 1}. ${file.name}\n`;
          });
          
          alert(message);
          
          // Open first PDF
          if (result.files.length > 0) {
            window.open(result.files[0].url, '_blank');
          }
        } else {
          alert('ì˜ìˆ˜ì¦ ìƒì„± ì‹¤íŒ¨: ' + result.message);
        }
      })
      .withFailureHandler(function(error) {
        hideLoadingMessage();
        alert('ì˜ìˆ˜ì¦ ìƒì„± ì¤‘ ì˜¤ë¥˜: ' + error);
      })
      .generateReceiptPDF(orderSerialNumber);
  }

  // Generate receipt from order list screen
  function generateReceiptFromList(orderSerialNumber) {
    showLoadingMessage('ì˜ìˆ˜ì¦ì„ ìƒì„±í•˜ëŠ” ì¤‘...');
    
    google.script.run
      .withSuccessHandler(function(result) {
        hideLoadingMessage();
        
        if (result.success) {
          alert(`ì˜ìˆ˜ì¦ ${result.count}ê°œê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!`);
          
          // Open first PDF
          if (result.files.length > 0) {
            window.open(result.files[0].url, '_blank');
          }
        } else {
          alert('ì˜ìˆ˜ì¦ ìƒì„± ì‹¤íŒ¨: ' + result.message);
        }
      })
      .withFailureHandler(function(error) {
        hideLoadingMessage();
        alert('ì˜ìˆ˜ì¦ ìƒì„± ì¤‘ ì˜¤ë¥˜: ' + error);
      })
      .generateReceiptPDF(orderSerialNumber);
  }

  // Customer Tab Functions
  let allCustomers = [];
  let customerSearchText = '';
  let customerSearchTimeout = null;

  // Show customer screen
  function showCustomer() {
    hideAllScreens();
    const s = document.getElementById('customerScreen');
    s.style.display = 'block';
    s.classList.add('active');
    stopOrderQRCamera();
    
    // Reset search
    customerSearchText = '';
    document.getElementById('customerSearchInput').value = '';
    document.getElementById('customerSearchInfo').innerHTML = '<div class="loading-dot">ë¡œë”© ì¤‘...</div>';
    
    loadAllCustomers();

    navigateToScreen('customerScreen');
  }

  // Load all customers
  function loadAllCustomers() {
    document.getElementById('customerListContainer').innerHTML = '<div class="loading"><div class="spinner"></div><div>ê³ ê° ì •ë³´ ë¡œë”© ì¤‘...</div></div>';
    
    // âœ… Summary cardsë„ ë¡œë”© ìƒíƒœë¡œ ì´ˆê¸°í™”
    document.getElementById('totalSalesPrice').textContent = '-';
    document.getElementById('totalReceivedPrice').textContent = '-';
    document.getElementById('totalNonReceivedPrice').textContent = '-';

    google.script.run
      .withSuccessHandler(function(result) {
        if (result.success) {
          allCustomers = result.customers;
          customerSearchText = '';
          
          // Display all customers
          renderCustomers(allCustomers);
          updateCustomerSearchInfo(allCustomers.length, allCustomers.length);
          updateCustomerSummary(allCustomers);
        } else {
          document.getElementById('customerListContainer').innerHTML = '<div class="alert alert-error">' + result.message + '</div>';
        }
      })
      .withFailureHandler(function(error) {
        document.getElementById('customerListContainer').innerHTML = '<div class="alert alert-error">ê³ ê° ì •ë³´ ë¡œë“œ ì˜¤ë¥˜: ' + error + '</div>';
      })
      .getAllCustomers();
  }

  // Handle customer search with debounce
  function handleCustomerSearch() {
    if (customerSearchTimeout) {
      clearTimeout(customerSearchTimeout);
    }
    
    customerSearchTimeout = setTimeout(() => {
      executeCustomerSearch();
    }, 300);
  }

  // Execute customer search
  function executeCustomerSearch() {
    const searchInput = document.getElementById('customerSearchInput');
    customerSearchText = searchInput.value.trim().toLowerCase();
    
    if (customerSearchText === '') {
      renderCustomers(allCustomers);
      updateCustomerSearchInfo(allCustomers.length, allCustomers.length);
    } else {
      const filtered = allCustomers.filter(customer => 
        (customer.companyName && customer.companyName.toLowerCase().includes(customerSearchText))
      );
      
      renderCustomers(filtered);
      updateCustomerSearchInfo(filtered.length, allCustomers.length);
    }
  }

  // Render customers
  function renderCustomers(customers) {
    const container = document.getElementById('customerListContainer');
    
    if (customers.length === 0) {
      container.innerHTML = '<div class="alert alert-info">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
      return;
    }
    
    let html = '<div class="customer-list">';
    
    customers.forEach(function(customer) {
      const nonReceivedClass = customer.nonReceivedPrice > 0 ? 'has-debt' : 'no-debt';
      
      html += '<div class="customer-card ' + nonReceivedClass + '">';
      
      // Header
      html += '<div class="customer-card-header">';
      html += '<h4 class="customer-name">' + (customer.companyName || '-') + '</h4>';
      if (customer.nonReceivedPrice > 0) {
        html += '<span class="customer-badge badge-warning">ë¯¸ìˆ˜ê¸ˆ ìˆìŒ</span>';
      } else {
        html += '<span class="customer-badge badge-success">ì •ì‚° ì™„ë£Œ</span>';
      }
      html += '</div>';
      
      // Financial Info Grid
      html += '<div class="customer-info-grid">';
      
      html += '<div class="customer-info-item">';
      html += '<div class="customer-info-label">ë§¤ì¶œ</div>';
      html += '<div class="customer-info-value">' + (customer.salesPrice || 0).toLocaleString() + 'ì›</div>';
      html += '</div>';
      
      html += '<div class="customer-info-item">';
      html += '<div class="customer-info-label">ìˆ˜ê¸ˆ</div>';
      html += '<div class="customer-info-value">' + (customer.receivedPrice || 0).toLocaleString() + 'ì›</div>';
      html += '</div>';
      
      html += '<div class="customer-info-item">';
      html += '<div class="customer-info-label">âš ï¸ ë¯¸ìˆ˜ê¸ˆ</div>';
      if (customer.nonReceivedPrice > 0) {
        html += '<div class="customer-info-value customer-debt">' + customer.nonReceivedPrice.toLocaleString() + 'ì›</div>';
      } else {
        html += '<div class="customer-info-value">-</div>';
      }
      html += '</div>';
      
      html += '</div>';
      
      // Description
      if (customer.description) {
        html += '<div class="customer-description">';
        html += '<strong>ğŸ“ ë¹„ê³ :</strong> ' + customer.description;
        html += '</div>';
      }
      
      html += '</div>';
    });
    
    html += '</div>';
    
    container.innerHTML = html;
  }

  // Update customer search info
  function updateCustomerSearchInfo(displayCount, totalCount) {
    const infoDiv = document.getElementById('customerSearchInfo');
    
    if (!infoDiv) return;  // âœ… ìš”ì†Œê°€ ì—†ìœ¼ë©´ ë¦¬í„´

    if (customerSearchText === '') {
      infoDiv.innerHTML = 'ì „ì²´ <strong>' + totalCount + '</strong>ê°œ';
    } else {
      infoDiv.innerHTML = 'ê²€ìƒ‰ ê²°ê³¼: <strong>' + displayCount + '</strong>ê°œ / ì „ì²´ <strong>' + totalCount + '</strong>ê°œ';
    }
    
  }

  // Update summary cards
  function updateCustomerSummary(customers) {
    let totalSales = 0;
    let totalReceived = 0;
    let totalNonReceived = 0;
    
    customers.forEach(function(customer) {
      totalSales += customer.salesPrice || 0;
      totalReceived += customer.receivedPrice || 0;
      totalNonReceived += customer.nonReceivedPrice || 0;
    });
    
    document.getElementById('totalSalesPrice').textContent = totalSales.toLocaleString() + 'ì›';
    document.getElementById('totalReceivedPrice').textContent = totalReceived.toLocaleString() + 'ì›';
    document.getElementById('totalNonReceivedPrice').textContent = totalNonReceived.toLocaleString() + 'ì›';
  }


</script>
